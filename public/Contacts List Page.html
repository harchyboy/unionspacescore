<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="union-logo.svg" />
    <title>Contacts</title>
    <script src='https://cdn.tailwindcss.com'></script>
    <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    border: "var(--border)",
                    input: "var(--input)",
                    ring: "var(--ring)",
                    background: "var(--background)",
                    foreground: "var(--foreground)",
                    primary: {
                        DEFAULT: "var(--primary)",
                        foreground: "var(--primary-foreground)",
                    },
                    secondary: {
                        DEFAULT: "var(--secondary)",
                        foreground: "var(--secondary-foreground)",
                    },
                    destructive: {
                        DEFAULT: "var(--destructive)",
                        foreground: "var(--destructive-foreground)",
                    },
                    muted: {
                        DEFAULT: "var(--muted)",
                        foreground: "var(--muted-foreground)",
                    },
                    accent: {
                        DEFAULT: "var(--accent)",
                        foreground: "var(--accent-foreground)",
                    },
                    popover: {
                        DEFAULT: "var(--popover)",
                        foreground: "var(--popover-foreground)",
                    },
                    card: {
                        DEFAULT: "var(--card)",
                        foreground: "var(--card-foreground)",
                    },
                },
                borderRadius: {
                    lg: "var(--radius)",
                    md: "calc(var(--radius) - 2px)",
                    sm: "calc(var(--radius) - 4px)",
                },
                fontFamily: {
                    sans: ["var(--font-sans)"],
                    serif: ["var(--font-serif)"],
                    mono: ["var(--font-mono)"],
                },
                boxShadow: {
                    '2xs': 'var(--shadow-2xs)',
                    'xs': 'var(--shadow-xs)',
                    'sm': 'var(--shadow-sm)',
                    'DEFAULT': 'var(--shadow)',
                    'md': 'var(--shadow-md)',
                    'lg': 'var(--shadow-lg)',
                    'xl': 'var(--shadow-xl)',
                    '2xl': 'var(--shadow-2xl)',
                },
            },
        }
    }
    </script>
    <script>
        window.FontAwesomeConfig = { autoReplaceSvg: 'nest'};
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: #FAFAFA;
            --foreground: #0f172a;
            --card: #ffffff;
            --card-foreground: #0f172a;
            --primary: #252525;
            --primary-foreground: #ffffff;
            --secondary: #8E8E8E;
            --secondary-foreground: #ffffff;
            --muted: #FAFAFA;
            --muted-foreground: #0f172a;
            --accent: #8E8E8E;
            --accent-foreground: #ffffff;
            --destructive: #ef4444;
            --destructive-foreground: #ffffff;
            --border: #E6E6E6;
            --input: #FFFFFF;
            --ring: #94a3b8;
            --font-sans: Inter, sans-serif;
            --font-serif: Georgia, serif;
            --font-mono: JetBrains Mono, monospace;
            --radius: 10px;
            --shadow: -2px 4px 12px 4px rgba(51,51,51,0.05);
        }
        
        ::-webkit-scrollbar { display: none;}
        
        body {
            font-family: var(--font-sans);
            background-color: #F0F0F0;
            color: #252525;
        }
        
        .transition-all-smooth {
            transition: all 0.2s ease-in-out;
        }
        
        .hover-lift:hover {
            transform: translateY(-2px);
        }
        
        .slide-over {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .slide-over.open {
            transform: translateX(0);
        }
        
        .field-group {
            opacity: 0;
            animation: fadeInUp 0.3s ease-out forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .field-group:nth-child(1) { animation-delay: 0.05s; }
        .field-group:nth-child(2) { animation-delay: 0.1s; }
        .field-group:nth-child(3) { animation-delay: 0.15s; }
        .field-group:nth-child(4) { animation-delay: 0.2s; }
        .field-group:nth-child(5) { animation-delay: 0.25s; }
        .field-group:nth-child(6) { animation-delay: 0.3s; }
        .field-group:nth-child(7) { animation-delay: 0.35s; }
        .field-group:nth-child(8) { animation-delay: 0.4s; }
        .field-group:nth-child(9) { animation-delay: 0.45s; }
    </style>
    <script src="sidebar.js" defer></script>
</head>
<body class="antialiased">

<div id="app-shell" class="flex h-screen overflow-hidden">
    
    <aside id="sidebar" class="w-64 bg-white border-r border-[#E6E6E6] flex flex-col" data-sidebar-placeholder data-active="contacts"></aside>
    
    <main id="main-content" class="flex-1 flex flex-col overflow-hidden">
        
        <header id="header" class="bg-white border-b border-[#E6E6E6] px-8 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-6 flex-1">
                <div class="relative flex-1 max-w-xl">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-secondary"></i>
                    <input type="text" placeholder="Search contacts, companies, brokers..." class="w-full pl-11 pr-4 py-2.5 bg-muted border border-[#E6E6E6] rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <button class="relative p-2 text-secondary hover:text-primary transition-all-smooth">
                    <i class="fa-solid fa-bell text-lg"></i>
                    <span class="absolute top-1 right-1 w-2 h-2 bg-destructive rounded-full"></span>
                </button>
                <button class="p-2 text-secondary hover:text-primary transition-all-smooth">
                    <i class="fa-solid fa-question-circle text-lg"></i>
                </button>
            </div>
        </header>
        
        <div id="page-header" class="bg-white border-b border-[#E6E6E6] px-8 py-6">
            <div class="flex items-start justify-between">
                <div>
                    <h1 class="text-3xl font-semibold text-primary mb-2">Contacts</h1>
                    <p class="text-secondary text-sm">Manage brokers, tenants, landlords, and supplier relationships</p>
                </div>
                <button id="add-contact-btn" class="bg-primary text-white px-6 py-2.5 rounded-lg font-medium hover:bg-opacity-90 transition-all-smooth flex items-center space-x-2">
                    <i class="fa-solid fa-plus"></i>
                    <span>Add Contact</span>
                </button>
            </div>
            
            <div class="flex items-center space-x-4 mt-6">
                <button class="px-4 py-2 text-sm font-medium text-primary border-b-2 border-primary">Brokers</button>
                <button class="px-4 py-2 text-sm font-medium text-secondary hover:text-primary border-b-2 border-transparent hover:border-secondary transition-all-smooth">Disposal Agents</button>
                <button class="px-4 py-2 text-sm font-medium text-secondary hover:text-primary border-b-2 border-transparent hover:border-secondary transition-all-smooth">Traditional Tenant Reps</button>
                <button class="px-4 py-2 text-sm font-medium text-secondary hover:text-primary border-b-2 border-transparent hover:border-secondary transition-all-smooth">Suppliers</button>
                <div class="flex-1"></div>
                <button class="text-secondary hover:text-primary text-sm flex items-center space-x-1">
                    <i class="fa-solid fa-filter"></i>
                    <span>Filters</span>
                </button>
                <button class="text-secondary hover:text-primary text-sm flex items-center space-x-1">
                    <i class="fa-solid fa-download"></i>
                    <span>Export</span>
                </button>
            </div>
        </div>
        
        <div id="filters-section" class="bg-white border-b border-[#E6E6E6] px-8 py-4">
            <div class="flex items-center space-x-3 flex-wrap gap-2">
                <div class="relative">
                    <select id="filter-firm" class="appearance-none bg-muted border border-[#E6E6E6] rounded-lg px-4 py-2 pr-8 text-sm text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="all">All Firms</option>
                        <option value="Knight Frank">Knight Frank</option>
                        <option value="CBRE">CBRE</option>
                        <option value="JLL">JLL</option>
                        <option value="Savills">Savills</option>
                        <option value="Cushman & Wakefield">Cushman & Wakefield</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-secondary text-xs pointer-events-none"></i>
                </div>
                
                <div class="relative">
                    <select id="filter-submarket" class="appearance-none bg-muted border border-[#E6E6E6] rounded-lg px-4 py-2 pr-8 text-sm text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="all">All Submarkets</option>
                        <option value="City Core">City Core</option>
                        <option value="Shoreditch">Shoreditch</option>
                        <option value="Mayfair">Mayfair</option>
                        <option value="Canary Wharf">Canary Wharf</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-secondary text-xs pointer-events-none"></i>
                </div>
                
                <div class="relative">
                    <select id="filter-activity" class="appearance-none bg-muted border border-[#E6E6E6] rounded-lg px-4 py-2 pr-8 text-sm text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="all">All Activity</option>
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="365">Last year</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-secondary text-xs pointer-events-none"></i>
                </div>
                
                <div class="relative">
                    <select id="filter-health" class="appearance-none bg-muted border border-[#E6E6E6] rounded-lg px-4 py-2 pr-8 text-sm text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="all">All Relationship Health</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                        <option value="Needs Attention">Needs Attention</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-secondary text-xs pointer-events-none"></i>
                </div>
                
                <button id="clear-filters" class="text-secondary hover:text-primary text-sm ml-2">
                    Clear all
                </button>
            </div>
        </div>
        
        <div id="contacts-list" class="flex-1 overflow-y-auto bg-[#F0F0F0] px-8 py-6">
            <div class="bg-white rounded-lg border border-[#E6E6E6] overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-muted border-b border-[#E6E6E6]">
                            <tr>
                                <th class="px-6 py-3 text-left">
                                    <input type="checkbox" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Company</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Phone</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Last Activity</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Open Items</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Health</th>
                                <th class="px-6 py-3 text-right text-xs font-semibold text-secondary uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contacts-table-body" class="divide-y divide-[#E6E6E6]">
                            <tr>
                                <td colspan="10" class="px-6 py-12 text-center text-secondary text-sm">
                                    Loading contacts...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="bulk-actions-bar" class="mt-6 flex items-center justify-between">
                <div id="contact-count" class="text-sm text-secondary">
                    Showing 26 of 26 contacts
                </div>
                <div class="flex items-center space-x-2">
                    <button class="px-4 py-2 border border-[#E6E6E6] rounded-lg text-sm text-primary hover:bg-muted transition-all-smooth flex items-center space-x-2">
                        <i class="fa-solid fa-envelope"></i>
                        <span>Send Email</span>
                    </button>
                    <button class="px-4 py-2 border border-[#E6E6E6] rounded-lg text-sm text-primary hover:bg-muted transition-all-smooth flex items-center space-x-2">
                        <i class="fa-solid fa-tag"></i>
                        <span>Add Tags</span>
                    </button>
                    <button class="px-4 py-2 border border-[#E6E6E6] rounded-lg text-sm text-primary hover:bg-muted transition-all-smooth flex items-center space-x-2">
                        <i class="fa-solid fa-file-export"></i>
                        <span>Export Selected</span>
                    </button>
                </div>
            </div>
            
            <div id="quick-stats" class="mt-8 grid grid-cols-4 gap-6">
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-secondary text-sm font-medium">Total Contacts</div>
                        <i class="fa-solid fa-users text-primary"></i>
                    </div>
                    <div class="text-3xl font-semibold text-primary">26</div>
                    <div class="text-xs text-secondary mt-2">+8 this month</div>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-secondary text-sm font-medium">Active Brokers</div>
                        <i class="fa-solid fa-handshake text-primary"></i>
                    </div>
                    <div class="text-3xl font-semibold text-primary">34</div>
                    <div class="text-xs text-secondary mt-2">18 preferred</div>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-secondary text-sm font-medium">Active Tenants</div>
                        <i class="fa-solid fa-user-tie text-primary"></i>
                    </div>
                    <div class="text-3xl font-semibold text-primary">28</div>
                    <div class="text-xs text-secondary mt-2">12 in onboarding</div>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-secondary text-sm font-medium">Avg Response Time</div>
                        <i class="fa-solid fa-clock text-primary"></i>
                    </div>
                    <div class="text-3xl font-semibold text-primary">4.2h</div>
                    <div class="text-xs text-secondary mt-2">-0.8h vs last month</div>
                </div>
            </div>
            
            <div class="mt-8">
                <div id="broker-performance-section" class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-primary">Top Broker Performance</h3>
                        <button class="text-sm text-secondary hover:text-primary">View All</button>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between pb-3 border-b border-[#E6E6E6]">
                            <div class="flex items-center space-x-3">
                                <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=128&h=128&fit=crop&crop=faces" alt="James Parker" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <div class="text-sm font-medium text-primary">James Parker</div>
                                    <div class="text-xs text-secondary">Knight Frank</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-semibold text-primary">£1.2M</div>
                                <div class="text-xs text-secondary">8 conversions</div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between pb-3 border-b border-[#E6E6E6]">
                            <div class="flex items-center space-x-3">
                                <img src="https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=128&h=128&fit=crop&crop=faces" alt="Oliver Martinez" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <div class="text-sm font-medium text-primary">Oliver Martinez</div>
                                    <div class="text-xs text-secondary">JLL</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-semibold text-primary">£890K</div>
                                <div class="text-xs text-secondary">6 conversions</div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between pb-3 border-b border-[#E6E6E6]">
                            <div class="flex items-center space-x-3">
                                <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=128&h=128&fit=crop&crop=faces" alt="Rachel Green" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <div class="text-sm font-medium text-primary">Rachel Green</div>
                                    <div class="text-xs text-secondary">Savills</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-semibold text-primary">£750K</div>
                                <div class="text-xs text-secondary">5 conversions</div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <img src="https://images.unsplash.com/photo-1519085360753-af0119f7cbe7?w=128&h=128&fit=crop&crop=faces" alt="Tom Anderson" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <div class="text-sm font-medium text-primary">Tom Anderson</div>
                                    <div class="text-xs text-secondary">CBRE</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-semibold text-primary">£620K</div>
                                <div class="text-xs text-secondary">4 conversions</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="recent-activity" class="mt-8">
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <h3 class="text-lg font-semibold text-primary mb-6">Recent Activity</h3>
                    <div class="space-y-4">
                        <div class="flex items-start space-x-4 pb-4 border-b border-[#E6E6E6]">
                            <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-envelope text-white text-xs"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm text-primary font-medium">Email logged with James Parker</div>
                                <div class="text-xs text-secondary mt-1">Viewing scheduled for 99 Bishopsgate - 3rd floor suite</div>
                                <div class="text-xs text-secondary mt-1">2 hours ago</div>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-4 pb-4 border-b border-[#E6E6E6]">
                            <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-user-plus text-white text-xs"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm text-primary font-medium">New contact added</div>
                                <div class="text-xs text-secondary mt-1">Emma Wilson from CleanPro Services added as Supplier</div>
                                <div class="text-xs text-secondary mt-1">5 hours ago</div>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-4 pb-4 border-b border-[#E6E6E6]">
                            <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-phone text-white text-xs"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm text-primary font-medium">Call logged with Sarah Chen</div>
                                <div class="text-xs text-secondary mt-1">Discussed floorplan updates for Principal Place</div>
                                <div class="text-xs text-secondary mt-1">1 day ago</div>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-4">
                            <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-handshake text-white text-xs"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm text-primary font-medium">Deal closed with Michael Roberts</div>
                                <div class="text-xs text-secondary mt-1">TechCorp Ltd signed for The Leadenhall Building</div>
                                <div class="text-xs text-secondary mt-1">3 days ago</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="communication-insights" class="mt-8">
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <h3 class="text-lg font-semibold text-primary mb-6">Communication Insights</h3>
                    <div class="grid grid-cols-3 gap-6">
                        <div class="text-center">
                            <div class="text-3xl font-semibold text-primary mb-2">284</div>
                            <div class="text-sm text-secondary">Emails This Month</div>
                            <div class="text-xs text-green-600 mt-1">+12% vs last month</div>
                        </div>
                        <div class="text-center border-l border-r border-[#E6E6E6]">
                            <div class="text-3xl font-semibold text-primary mb-2">127</div>
                            <div class="text-sm text-secondary">Calls Logged</div>
                            <div class="text-xs text-green-600 mt-1">+8% vs last month</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-semibold text-primary mb-2">45</div>
                            <div class="text-sm text-secondary">Meetings Scheduled</div>
                            <div class="text-xs text-red-600 mt-1">-3% vs last month</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </main>
</div>

<!-- Contact Details Slide-Over Panel -->
<div id="contact-details-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50" onclick="closeContactDetails()"></div>
<div id="contact-details-panel" class="slide-over fixed right-0 top-0 bottom-0 w-5/6 max-w-7xl bg-white shadow-2xl z-50 overflow-y-auto">
    <div id="contact-details-content">
        <div class="text-center py-12 text-secondary">
            <i class="fa-solid fa-user text-4xl mb-4"></i>
            <p>Select a contact to view details</p>
        </div>
    </div>
</div>

<div id="add-contact-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
    <div class="min-h-screen bg-[#F0F0F0]">
        <div class="bg-white border-b border-[#E6E6E6] px-8 py-4 sticky top-0 z-10">
            <div class="max-w-4xl mx-auto flex items-center justify-between">
                <button id="back-button" class="flex items-center space-x-2 text-secondary hover:text-primary transition-all-smooth">
                    <i class="fa-solid fa-arrow-left"></i>
                    <span class="text-sm font-medium">Back to Contacts</span>
                </button>
                <button id="close-modal" class="text-secondary hover:text-primary p-2">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <div class="bg-white border-b border-[#E6E6E6] px-8 py-6">
            <div class="max-w-4xl mx-auto">
                <h1 id="contact-modal-title" class="text-3xl font-semibold text-primary mb-2">Add Contact</h1>
                <p id="contact-modal-subtitle" class="text-secondary text-sm">Expand your network. Fill in the details below to create a new contact record.</p>
            </div>
        </div>
        
        <div class="px-8 py-8">
            <div class="max-w-4xl mx-auto">
                <form id="add-contact-form" class="space-y-8">
                    <div id="contact-type-section" class="bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Contact Type</h2>
                            <p class="text-sm text-secondary">Define the relationship and role of this contact</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="relative flex flex-col items-center justify-center px-6 py-6 border-2 border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth bg-muted">
                                <input type="radio" name="type" value="flex-broker" class="sr-only peer" required>
                                <i class="fa-solid fa-handshake text-3xl text-secondary peer-checked:text-primary mb-3"></i>
                                <span class="text-sm font-semibold text-secondary peer-checked:text-primary">Brokers</span>
                                <span class="text-xs text-secondary mt-1">Tenant representative</span>
                                <div class="absolute inset-0 border-2 border-transparent peer-checked:border-primary rounded-lg pointer-events-none"></div>
                            </label>
                            <label class="relative flex flex-col items-center justify-center px-6 py-6 border-2 border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth bg-muted">
                                <input type="radio" name="type" value="disposal-agent" class="sr-only peer">
                                <i class="fa-solid fa-building text-3xl text-secondary peer-checked:text-primary mb-3"></i>
                                <span class="text-sm font-semibold text-secondary peer-checked:text-primary">Disposal Agents</span>
                                <span class="text-xs text-secondary mt-1">Landlord representative</span>
                                <div class="absolute inset-0 border-2 border-transparent peer-checked:border-primary rounded-lg pointer-events-none"></div>
                            </label>
                            <label class="relative flex flex-col items-center justify-center px-6 py-6 border-2 border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth bg-muted">
                                <input type="radio" name="type" value="tenant" class="sr-only peer">
                                <i class="fa-solid fa-user-tie text-3xl text-secondary peer-checked:text-primary mb-3"></i>
                                <span class="text-sm font-semibold text-secondary peer-checked:text-primary">Traditional Tenant Reps</span>
                                <span class="text-xs text-secondary mt-1">Occupier contact</span>
                                <div class="absolute inset-0 border-2 border-transparent peer-checked:border-primary rounded-lg pointer-events-none"></div>
                            </label>
                            <label class="relative flex flex-col items-center justify-center px-6 py-6 border-2 border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth bg-muted">
                                <input type="radio" name="type" value="supplier" class="sr-only peer">
                                <i class="fa-solid fa-wrench text-3xl text-secondary peer-checked:text-primary mb-3"></i>
                                <span class="text-sm font-semibold text-secondary peer-checked:text-primary">Suppliers</span>
                                <span class="text-xs text-secondary mt-1">Service provider</span>
                                <div class="absolute inset-0 border-2 border-transparent peer-checked:border-primary rounded-lg pointer-events-none"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div id="personal-details-section" class="bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Personal Details</h2>
                            <p class="text-sm text-secondary">Basic contact information</p>
                        </div>
                        <div class="space-y-6">
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold text-primary mb-2">First Name <span class="text-destructive">*</span></label>
                                    <input type="text" name="first_name" required class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="John">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-primary mb-2">Last Name <span class="text-destructive">*</span></label>
                                    <input type="text" name="last_name" required class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="Smith">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Role / Title</label>
                                <input type="text" name="role" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="e.g., Partner, Director, Head of Property">
                            </div>
                        </div>
                    </div>
                    
                    <div id="company-details-section" class="bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Company Details</h2>
                            <p class="text-sm text-secondary">Organisation and firm information</p>
                        </div>
                        <div class="space-y-6">
                            <div class="relative">
                                <label class="block text-sm font-semibold text-primary mb-2">Company Name <span class="text-destructive">*</span></label>
                                <div class="relative">
                                    <input type="text" id="company-input" name="company" required class="w-full px-4 py-3 pr-12 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="e.g., Knight Frank, CBRE, JLL">
                                    <button type="button" id="company-lookup-btn" class="absolute right-4 top-1/2 transform -translate-y-1/2 p-1.5 text-secondary hover:text-primary transition-all-smooth rounded hover:bg-muted" title="Search existing companies" style="margin-top: 0;">
                                        <i class="fa-solid fa-ellipsis-vertical text-sm"></i>
                                    </button>
                                </div>
                                <div id="company-suggestions" class="hidden absolute z-50 w-full mt-1 bg-white border border-[#E6E6E6] rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                    <div class="py-1" id="company-suggestions-list">
                                        <!-- Suggestions will be populated here -->
                                    </div>
                                </div>
                                <p class="text-xs text-secondary mt-2">If the firm doesn't exist, we'll create it automatically</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">City / Region</label>
                                <input type="text" name="city" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="London">
                            </div>
                        </div>
                    </div>
                    
                    <div id="contact-information-section" class="bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Contact Information</h2>
                            <p class="text-sm text-secondary">How to reach this contact</p>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Email Address <span class="text-destructive">*</span></label>
                                <input type="email" name="email" required class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="john.smith@example.com">
                                <p class="text-xs text-secondary mt-2">Primary email for all communications</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Phone Number</label>
                                <input type="tel" name="phone" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="+44 20 1234 5678">
                            </div>
                        </div>
                    </div>
                    
                    <div id="broker-specific-section" class="hidden bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Broker Details</h2>
                            <p class="text-sm text-secondary">Additional information for broker contacts</p>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Brokerage Territory</label>
                                <input type="text" name="territory" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="e.g., City Core, West End">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Specialisms</label>
                                <input type="text" name="specialisms" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="e.g., Tech, Finance, Creative">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Preferred Submarkets</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <label class="flex items-center space-x-2 px-4 py-3 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                        <input type="checkbox" name="submarket" value="city-core" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                        <span class="text-sm text-primary">City Core</span>
                                    </label>
                                    <label class="flex items-center space-x-2 px-4 py-3 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                        <input type="checkbox" name="submarket" value="shoreditch" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                        <span class="text-sm text-primary">Shoreditch</span>
                                    </label>
                                    <label class="flex items-center space-x-2 px-4 py-3 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                        <input type="checkbox" name="submarket" value="mayfair" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                        <span class="text-sm text-primary">Mayfair</span>
                                    </label>
                                    <label class="flex items-center space-x-2 px-4 py-3 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                        <input type="checkbox" name="submarket" value="canary-wharf" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                        <span class="text-sm text-primary">Canary Wharf</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Referral Source</label>
                                <input type="text" name="referral_source" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="How did this broker find UNION?">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Commission Structure</label>
                                <textarea name="commission_notes" rows="2" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="Reference notes on commission agreement"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div id="disposal-agent-section" class="hidden bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Disposal Agent Details</h2>
                            <p class="text-sm text-secondary">Additional information for disposal agent contacts</p>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Landlord Roster</label>
                                <input type="text" name="landlord_roster" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="e.g., British Land, Landsec, Derwent">
                                <p class="text-xs text-secondary mt-2">Comma-separated list of landlords this agent represents</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Instruction Types</label>
                                <div class="grid grid-cols-3 gap-3">
                                    <label class="flex items-center space-x-2 px-4 py-3 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                        <input type="checkbox" name="instruction_type" value="cat-a" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                        <span class="text-sm text-primary">Cat A</span>
                                    </label>
                                    <label class="flex items-center space-x-2 px-4 py-3 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                        <input type="checkbox" name="instruction_type" value="cat-a-plus" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                        <span class="text-sm text-primary">Cat A+</span>
                                    </label>
                                    <label class="flex items-center space-x-2 px-4 py-3 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                        <input type="checkbox" name="instruction_type" value="fitted" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                        <span class="text-sm text-primary">Fitted</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="supplier-specific-section" class="hidden bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Supplier Details</h2>
                            <p class="text-sm text-secondary">Service provider information</p>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Service Category</label>
                                <select name="service_category" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth appearance-none">
                                    <option value="">Select category</option>
                                    <option value="cleaning">Cleaning</option>
                                    <option value="av">AV & Technology</option>
                                    <option value="it">IT Support</option>
                                    <option value="maintenance">Repairs & Maintenance</option>
                                    <option value="plants">Plants & Greenery</option>
                                    <option value="coffee">Coffee & Beverages</option>
                                    <option value="furniture">Furniture</option>
                                    <option value="utilities">Utilities</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Coverage Areas</label>
                                <input type="text" name="coverage_areas" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="e.g., Central London, EC1-EC4">
                            </div>
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold text-primary mb-2">Rate Card (£/hour)</label>
                                    <input type="number" name="rate_card" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="50">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-primary mb-2">Lead Time (days)</label>
                                    <input type="number" name="lead_time" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="3">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="relationship-section" class="bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Relationship & Notes</h2>
                            <p class="text-sm text-secondary">Context for future interactions</p>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Relationship Notes</label>
                                <textarea name="relationship_notes" rows="4" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="Add context about this relationship—how you met, communication preferences, past interactions..."></textarea>
                                <p class="text-xs text-secondary mt-2">This helps shape tone and approach in future communications</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="preferences-section" class="bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Communication Preferences</h2>
                            <p class="text-sm text-secondary">How this contact prefers to engage</p>
                        </div>
                        <div class="space-y-4">
                            <label class="flex items-start space-x-3 p-4 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                <input type="checkbox" name="email_logging" class="w-5 h-5 text-primary border-[#E6E6E6] rounded focus:ring-primary mt-0.5">
                                <div class="flex-1">
                                    <span class="text-sm font-semibold text-primary block">Email logging consent</span>
                                    <span class="text-xs text-secondary mt-1 block">Automatically associate emails with this contact's record</span>
                                </div>
                            </label>
                            <label class="flex items-start space-x-3 p-4 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                <input type="checkbox" name="confidential_requirement" class="w-5 h-5 text-primary border-[#E6E6E6] rounded focus:ring-primary mt-0.5">
                                <div class="flex-1">
                                    <span class="text-sm font-semibold text-primary block">Confidential requirement flag</span>
                                    <span class="text-xs text-secondary mt-1 block">This broker typically works with confidential tenant identities</span>
                                </div>
                            </label>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Communication Cadence</label>
                                <select name="updates_cadence" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth appearance-none">
                                    <option value="weekly">Weekly updates</option>
                                    <option value="fortnightly">Fortnightly updates</option>
                                    <option value="monthly" selected>Monthly updates</option>
                                    <option value="on-demand">On-demand only</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Contact Status</label>
                                <select name="status" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth appearance-none">
                                    <option value="active" selected>Active</option>
                                    <option value="do-not-contact">Do not contact</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="form-actions" class="flex items-center justify-between pt-6 field-group">
                        <button type="button" id="cancel-button" class="px-8 py-3 border-2 border-[#E6E6E6] text-primary rounded-lg font-semibold hover:bg-muted transition-all-smooth">
                            Cancel
                        </button>
                        <div class="flex items-center space-x-4">
                            <button type="button" id="save-draft-button" class="px-8 py-3 border-2 border-primary text-primary rounded-lg font-semibold hover:bg-muted transition-all-smooth">
                                Save Draft
                            </button>
                            <button type="submit" class="px-8 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-opacity-90 transition-all-smooth flex items-center space-x-2">
                                <span>Add Contact</span>
                                <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="success-toast" class="hidden fixed bottom-8 right-8 bg-primary text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 z-50">
    <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
        <i class="fa-solid fa-check text-white"></i>
    </div>
    <div>
        <div id="success-toast-title" class="font-semibold">Contact added successfully</div>
        <div id="success-toast-subtitle" class="text-xs opacity-90">Record created and ready to use</div>
    </div>
</div>

<script>
const CONTACTS_API_URL = '/api/contacts';
let contactsData = [];
let isFetchingContacts = false;

const CONTACT_TYPE_META = {
    'Flex Broker': { label: 'Brokers', displayLabel: 'Broker', icon: 'fa-handshake', badgeClass: 'bg-primary text-white' },
    'Disposal Agent': { label: 'Disposal Agents', icon: 'fa-building', badgeClass: 'bg-secondary text-white' },
    Tenant: { label: 'Traditional Tenant Reps', icon: 'fa-user-tie', badgeClass: 'bg-accent text-white' },
    Supplier: { label: 'Supplier', icon: 'fa-wrench', badgeClass: 'bg-muted text-primary' },
    Landlord: { label: 'Landlord', icon: 'fa-landmark', badgeClass: 'bg-muted text-primary' },
    default: { label: 'Contact', icon: 'fa-user', badgeClass: 'bg-muted text-primary' },
};

const HEALTH_BADGES = {
    Excellent: 'bg-green-100 text-green-800',
    Good: 'bg-green-100 text-green-800',
    Fair: 'bg-yellow-100 text-yellow-800',
    'Needs Attention': 'bg-red-100 text-red-800',
};

const TYPE_VALUE_MAP = {
    'flex-broker': 'Flex Broker',
    'disposal-agent': 'Disposal Agent',
    tenant: 'Tenant',
    supplier: 'Supplier',
};

const TYPE_LABEL_TO_VALUE = {
    'Flex Broker': 'flex-broker',
    Broker: 'flex-broker',
    'Disposal Agent': 'disposal-agent',
    Tenant: 'tenant',
    Supplier: 'supplier',
};

let isEditingContact = false;
let editingContactId = null;

const contactModalElements = {
    modal: null,
    form: null,
    modalTitle: null,
    modalSubtitle: null,
    submitButton: null,
    submitLabel: null,
    successToast: null,
    successToastTitle: null,
    successToastSubtitle: null,
    typeRadios: [],
    brokerSection: null,
    disposalSection: null,
    supplierSection: null,
};

function normalizeContactsResponse(data) {
    if (!data) return [];
    if (Array.isArray(data.items)) return data.items;
    if (Array.isArray(data.contacts)) return data.contacts;
    if (Array.isArray(data.data)) return data.data;
    return [];
}

function escapeHtml(value) {
    if (!value) return '';
    return value.replace(/[&<>"']/g, function(match) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return map[match];
    });
}

function formatLastActivity(hours) {
    if (hours === null || hours === undefined || Number.isNaN(hours)) return '—';
    if (hours < 1) return 'Just now';
    if (hours < 24) return `${hours} hour${hours === 1 ? '' : 's'} ago`;
    const days = Math.floor(hours / 24);
    return `${days} day${days === 1 ? '' : 's'} ago`;
}

function setTypeSections(value) {
    const { brokerSection, disposalSection, supplierSection } = contactModalElements;
    if (brokerSection) brokerSection.classList.add('hidden');
    if (disposalSection) disposalSection.classList.add('hidden');
    if (supplierSection) supplierSection.classList.add('hidden');

    if (value === 'flex-broker' && brokerSection) {
        brokerSection.classList.remove('hidden');
    } else if (value === 'disposal-agent' && disposalSection) {
        disposalSection.classList.remove('hidden');
    } else if (value === 'supplier' && supplierSection) {
        supplierSection.classList.remove('hidden');
    }
}

function selectContactType(value) {
    if (!contactModalElements.typeRadios.length) return;
    contactModalElements.typeRadios.forEach(function(radio) {
        radio.checked = value ? radio.value === value : false;
    });
    setTypeSections(value);
}

async function fetchContactById(id) {
    const response = await fetch(`${CONTACTS_API_URL}/${id}`);
    if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.message || 'Failed to load contact');
    }
    return response.json();
}

async function updateContactApi(id, payload) {
    const response = await fetch(`${CONTACTS_API_URL}/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
    });

    if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.message || 'Failed to update contact');
    }

    return response.json();
}

function closeContactModal() {
    const { modal, form } = contactModalElements;
    if (modal) {
        modal.classList.add('hidden');
    }
    document.body.style.overflow = '';
    if (form) {
        form.reset();
    }
    isEditingContact = false;
    editingContactId = null;
    selectContactType(null);
}

function populateContactForm(contactData) {
    const { form } = contactModalElements;
    if (!form || !contactData) return;

    const firstNameInput = form.querySelector('input[name="first_name"]');
    const lastNameInput = form.querySelector('input[name="last_name"]');
    const emailInput = form.querySelector('input[name="email"]');
    const phoneInput = form.querySelector('input[name="phone"]');
    const companyInput = form.querySelector('input[name="company"]');
    const roleInput = form.querySelector('input[name="role"]');

    if (firstNameInput) firstNameInput.value = contactData.firstName || '';
    if (lastNameInput) lastNameInput.value = contactData.lastName || '';
    if (emailInput) emailInput.value = contactData.email || '';
    if (phoneInput) phoneInput.value = contactData.phone || contactData.mobile || '';
    if (companyInput) companyInput.value = contactData.company || '';
    if (roleInput) roleInput.value = contactData.role || '';

    const typeValue = TYPE_LABEL_TO_VALUE[contactData.type] || 'flex-broker';
    selectContactType(typeValue);
}

function openContactModal(mode = 'add', contactData = null) {
    const {
        modal,
        form,
        modalTitle,
        modalSubtitle,
        submitLabel,
    } = contactModalElements;

    if (!modal || !form) return;

    isEditingContact = mode === 'edit';
    editingContactId = isEditingContact && contactData ? contactData.id : null;

    if (modalTitle) modalTitle.textContent = isEditingContact ? 'Edit Contact' : 'Add Contact';
    if (modalSubtitle) {
        modalSubtitle.textContent = isEditingContact
            ? 'Update the details below to keep this record accurate.'
            : 'Expand your network. Fill in the details below to create a new contact record.';
    }
    if (submitLabel) submitLabel.textContent = isEditingContact ? 'Save Changes' : 'Add Contact';

    if (!isEditingContact || !contactData) {
        form.reset();
        selectContactType(null);
    } else {
        populateContactForm(contactData);
    }

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

async function openEditContact(contactId) {
    if (!contactId) return;
    try {
        const contact = await fetchContactById(contactId);
        openContactModal('edit', contact);
    } catch (error) {
        alert(error.message || 'Failed to load contact details.');
    }
}

function getTypeMeta(type) {
    return CONTACT_TYPE_META[type] || CONTACT_TYPE_META.default;
}

function renderContactsTable(contacts) {
    const tbody = document.getElementById('contacts-table-body');
    if (!tbody) return;

    contactsData = contacts;

    if (!contacts || contacts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="px-6 py-12 text-center text-secondary text-sm">
                    No contacts found
                </td>
            </tr>
        `;
        filterContacts();
        return;
    }

    const rowsHtml = contacts
        .map((contact) => {
            const rawName = contact.name || 'Unnamed Contact';
            const safeName = escapeHtml(rawName);
            const isBroker = contact.type === 'Flex Broker' || contact.type === 'flex-broker' || contact.type === 'Broker';
            const safeRole = isBroker ? '—' : escapeHtml(contact.role || '—');
            const safeCompany = escapeHtml(contact.company || '—');
            const safeEmail = escapeHtml(contact.email || '—');
            const safePhone = escapeHtml(contact.phone || '—');
            const typeMeta = getTypeMeta(contact.type);
            const typeLabel = typeMeta.displayLabel || typeMeta.label;
            const health = contact.health || 'Good';
            const healthBadge = HEALTH_BADGES[health] || 'bg-muted text-primary';
            const lastActivity = formatLastActivity(contact.lastActivityHours);
            const activityValue =
                contact.lastActivityHours === null || contact.lastActivityHours === undefined
                    ? 9999
                    : contact.lastActivityHours;
            const initials =
                rawName
                    .split(/\s+/)
                    .filter(Boolean)
                    .map((part) => part[0])
                    .join('')
                    .slice(0, 2)
                    .toUpperCase() || 'UN';

            return `
            <tr class="hover:bg-muted transition-all-smooth cursor-pointer contact-row"
                data-contact-id="${contact.id || ''}"
                data-contact-name="${safeName}"
                data-contact-role="${safeRole}"
                data-contact-type="${contact.type || ''}"
                data-contact-company="${safeCompany}"
                data-contact-email="${safeEmail}"
                data-contact-phone="${safePhone}"
                data-contact-health="${health}"
                data-contact-activity-hours="${activityValue}"
                data-contact-submarket="${contact.submarket || ''}">
                <td class="px-6 py-4" onclick="event.stopPropagation()">
                    <input type="checkbox" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                </td>
                <td class="px-6 py-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-primary bg-opacity-10 flex items-center justify-center text-primary font-semibold">
                            ${initials}
                        </div>
                        <div>
                            <div class="font-semibold text-primary text-sm">${safeName}</div>
                            <div class="text-xs text-secondary">${safeRole}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${typeMeta.badgeClass}">
                        <i class="fa-solid ${typeMeta.icon} mr-1.5"></i>
                        ${typeLabel}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm text-primary">${safeCompany}</td>
                <td class="px-6 py-4 text-sm text-primary">${safeEmail}</td>
                <td class="px-6 py-4 text-sm text-secondary">${safePhone}</td>
                <td class="px-6 py-4 text-sm text-secondary">${lastActivity}</td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-muted text-primary">
                        <i class="fa-solid fa-chart-line mr-1"></i>
                        Not tracked
                    </span>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${healthBadge}">
                        <i class="fa-solid fa-circle mr-1.5 text-[6px]"></i>
                        ${health}
                    </span>
                </td>
                <td class="px-6 py-4 text-right">
                    <button class="text-secondary hover:text-primary">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </button>
                </td>
            </tr>
            `;
        })
        .join('');

    tbody.innerHTML = rowsHtml;
    attachContactRowHandlers();
    filterContacts();
}

async function fetchContacts(force = false) {
    if (isFetchingContacts && !force) return;
    isFetchingContacts = true;

    const tbody = document.getElementById('contacts-table-body');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="px-6 py-12 text-center text-secondary text-sm">
                    Loading contacts…
                </td>
            </tr>
        `;
    }

    try {
        const response = await fetch(CONTACTS_API_URL);
        if (!response.ok) {
            throw new Error('Unable to load contacts');
        }
        const data = await response.json();
        if (data.source === 'zoho_failed') {
            throw new Error('Zoho CRM returned an empty result. Please verify the integration credentials.');
        }
        const contacts = normalizeContactsResponse(data);
        renderContactsTable(contacts);
    } catch (error) {
        console.error(error);
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="px-6 py-12 text-center text-destructive text-sm">
                        Failed to load contacts. Please try again later.
                    </td>
                </tr>
            `;
        }
    } finally {
        isFetchingContacts = false;
    }
}

async function createContact(payload) {
    const response = await fetch(CONTACTS_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
    });

    if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.message || 'Failed to create contact');
    }

    return response.json();
}

function attachContactRowHandlers() {
    document.querySelectorAll('.contact-row').forEach(function(row) {
        if (row.dataset.clickBound === 'true') return;
        row.dataset.clickBound = 'true';
        row.addEventListener('click', function(e) {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON' && !e.target.closest('button')) {
                showContactDetails(row);
            }
        });
    });
}
function showContactDetails(row) {
    const name = row.dataset.contactName;
    const role = row.dataset.contactRole;
    const rawType = row.dataset.contactType;
    const isBroker = rawType === 'Flex Broker' || rawType === 'flex-broker' || rawType === 'Broker';
    const type = isBroker ? 'Broker' : rawType;
    const company = row.dataset.contactCompany;
    const email = row.dataset.contactEmail;
    const phone = row.dataset.contactPhone;
    const avatar = row.dataset.contactAvatar;
    const confidential = row.dataset.contactConfidential === 'true';
    const health = row.dataset.contactHealth || 'Good';
    
    const typeColors = {
        'Broker': 'bg-primary text-white',
        'Flex Broker': 'bg-primary text-white',
        'Disposal Agent': 'bg-secondary text-white',
        'Tenant': 'bg-accent text-white',
        'Landlord': 'bg-muted text-primary',
        'Supplier': 'bg-muted text-primary'
    };
    
    const typeIcon = {
        'Flex Broker': 'fa-handshake',
        'Disposal Agent': 'fa-building',
        'Tenant': 'fa-user-tie',
        'Landlord': 'fa-landmark',
        'Supplier': 'fa-wrench'
    };
    
    // Generate initials for avatar fallback
    const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
    
    document.getElementById('contact-details-content').innerHTML = `
        <div class="bg-white border-b border-[#E6E6E6] px-8 py-6 mb-0">
            <div class="flex items-center space-x-4 mb-4">
                <button onclick="closeContactDetails()" class="text-secondary hover:text-primary transition-all-smooth">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div class="flex items-center space-x-4 flex-1">
                    ${avatar ? `
                    <img src="${avatar}" alt="${name}" class="w-16 h-16 rounded-full object-cover">
                    ` : `
                    <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center text-white text-2xl font-semibold">
                        ${initials}
                    </div>
                    `}
                    <div>
                        <div class="flex items-center space-x-3 mb-1">
                            <h1 class="text-2xl font-semibold text-primary">${name}</h1>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${typeColors[type] || 'bg-muted text-primary'}">
                                ${type}
                            </span>
                            ${confidential ? '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-800"><i class="fa-solid fa-lock mr-1"></i>Confidential</span>' : ''}
                        </div>
                        <div class="flex items-center space-x-4 text-sm text-secondary">
                            <span class="flex items-center space-x-1">
                                <i class="fa-solid fa-building"></i>
                                <span>${company}</span>
                            </span>
                            ${isBroker ? `
                            <span class="flex items-center space-x-1">
                                <i class="fa-solid fa-map-marker-alt"></i>
                                <span>City Core, Shoreditch</span>
                            </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="bg-primary text-white px-5 py-2.5 rounded-lg font-medium hover:bg-opacity-90 transition-all-smooth flex items-center space-x-2">
                        <i class="fa-solid fa-envelope"></i>
                        <span>New Email</span>
                    </button>
                    <button class="border border-[#E6E6E6] text-primary px-5 py-2.5 rounded-lg font-medium hover:bg-muted transition-all-smooth flex items-center space-x-2">
                        <i class="fa-solid fa-phone"></i>
                        <span>Log Call</span>
                    </button>
                    <button class="border border-[#E6E6E6] text-primary px-5 py-2.5 rounded-lg font-medium hover:bg-muted transition-all-smooth flex items-center space-x-2">
                        <i class="fa-solid fa-calendar"></i>
                        <span>Create Viewing</span>
                    </button>
                    <button class="border border-[#E6E6E6] text-primary px-5 py-2.5 rounded-lg font-medium hover:bg-muted transition-all-smooth flex items-center space-x-2">
                        <i class="fa-solid fa-plus"></i>
                        <span>Add to Deal</span>
                    </button>
                    <button class="p-2.5 text-secondary hover:text-primary transition-all-smooth">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <button class="px-4 py-2 text-sm font-medium text-primary border-b-2 border-primary">Overview</button>
                <button class="px-4 py-2 text-sm font-medium text-secondary hover:text-primary border-b-2 border-transparent hover:border-secondary transition-all-smooth">Relationship Graph</button>
                <button class="px-4 py-2 text-sm font-medium text-secondary hover:text-primary border-b-2 border-transparent hover:border-secondary transition-all-smooth">Performance</button>
                <button class="px-4 py-2 text-sm font-medium text-secondary hover:text-primary border-b-2 border-transparent hover:border-secondary transition-all-smooth">Communications</button>
                <button class="px-4 py-2 text-sm font-medium text-secondary hover:text-primary border-b-2 border-transparent hover:border-secondary transition-all-smooth">Documents</button>
            </div>
        </div>
        
        <div class="bg-[#F0F0F0] p-8">
        
        <div class="grid grid-cols-3 gap-6">
            <div class="col-span-2 space-y-6">
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-primary">Contact Information</h3>
                        <button class="text-secondary hover:text-primary text-sm" data-action="edit-contact">
                            <i class="fa-solid fa-pencil mr-1"></i>
                            Edit
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Email</label>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-primary">${email}</span>
                                <button class="text-secondary hover:text-primary">
                                    <i class="fa-solid fa-copy text-xs"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Phone</label>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-primary">${phone}</span>
                                <button class="text-secondary hover:text-primary">
                                    <i class="fa-solid fa-copy text-xs"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Mobile</label>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-primary">Not provided</span>
                                <button class="text-secondary hover:text-primary">
                                    <i class="fa-solid fa-copy text-xs"></i>
                                </button>
                            </div>
                        </div>
                        
                        ${!isBroker ? `
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Role</label>
                            <span class="text-sm text-primary">${role}</span>
                        </div>
                        ` : ''}
                        
                        ${isBroker ? `
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Territory</label>
                            <span class="text-sm text-primary">Central London</span>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Specialisms</label>
                            <div class="flex flex-wrap gap-2">
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-muted text-primary">Tech Sector</span>
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-muted text-primary">Scale-ups</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Preferred Submarkets</label>
                            <span class="text-sm text-primary">City Core, Shoreditch</span>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Referral Source</label>
                            <span class="text-sm text-primary">Industry Event</span>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Commission Structure</label>
                            <span class="text-sm text-primary">Standard - 10% first year rent</span>
                        </div>
                        ` : ''}
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Relationship Health</label>
                            <div class="flex items-center space-x-2">
                                <div class="flex-1 bg-muted rounded-full h-2">
                                    <div class="bg-primary h-2 rounded-full" style="width: ${health === 'Excellent' ? '85%' : health === 'Good' ? '70%' : health === 'Fair' ? '50%' : '30%'}"></div>
                                </div>
                                <span class="text-xs text-secondary">${health}</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Last Contacted</label>
                            <span class="text-sm text-primary">Recently</span>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-[#E6E6E6]">
                        <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Relationship Notes</label>
                        <p class="text-sm text-primary leading-relaxed">Key contact for ${company}. ${isBroker ? 'Specializes in flexible office solutions and has a strong track record with quality referrals.' : type === 'Disposal Agent' ? 'Handles property disposals and has extensive market knowledge.' : 'Important relationship to maintain.'}</p>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-[#E6E6E6]">
                        <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-3">Comms Preferences</label>
                        <div class="flex items-center space-x-6">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" checked class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                <span class="text-sm text-primary">Email logging consent</span>
                            </label>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-secondary">Updates cadence:</span>
                                <select class="text-sm border border-[#E6E6E6] rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option>Weekly</option>
                                    <option>Bi-weekly</option>
                                    <option>Monthly</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${confidential ? `
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <h3 class="text-lg font-semibold text-primary">Confidential Requirements</h3>
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-destructive text-white">
                                <i class="fa-solid fa-lock mr-1"></i>
                                Confidential
                            </span>
                        </div>
                        <button class="text-secondary hover:text-primary text-sm">
                            <i class="fa-solid fa-plus mr-1"></i>
                            Add Requirement
                        </button>
                    </div>
                    <div class="text-sm text-secondary text-center py-4">
                        No confidential requirements at this time.
                    </div>
                </div>
                ` : ''}
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-primary">Communications History</h3>
                        <div class="flex items-center space-x-2">
                            <div class="relative">
                                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-secondary text-sm"></i>
                                <input type="text" placeholder="Search communications..." class="pl-9 pr-4 py-2 border border-[#E6E6E6] rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <select class="border border-[#E6E6E6] rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                                <option>All Types</option>
                                <option>Email</option>
                                <option>Call</option>
                                <option>Meeting</option>
                                <option>Note</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="flex space-x-4 pb-4 border-b border-[#E6E6E6]">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                                    <i class="fa-solid fa-envelope text-white text-sm"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-start justify-between mb-2">
                                    <div>
                                        <div class="font-medium text-primary text-sm mb-1">Email: Property Discussion</div>
                                        <div class="text-xs text-secondary">From: ${email}</div>
                                    </div>
                                    <div class="text-xs text-secondary">2 days ago</div>
                                </div>
                                <p class="text-sm text-primary leading-relaxed mb-3">Recent communication with ${name} regarding property requirements and availability.</p>
                                <div class="flex items-center space-x-3">
                                    <button class="text-xs text-primary hover:underline">View Full Email</button>
                                    <button class="text-xs text-primary hover:underline">Reply</button>
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-4 pb-4 border-b border-[#E6E6E6]">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                                    <i class="fa-solid fa-phone text-white text-sm"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-start justify-between mb-2">
                                    <div>
                                        <div class="font-medium text-primary text-sm mb-1">Call: Requirement Discussion</div>
                                        <div class="text-xs text-secondary">Duration: 15 minutes</div>
                                    </div>
                                    <div class="text-xs text-secondary">5 days ago</div>
                                </div>
                                <p class="text-sm text-primary leading-relaxed mb-3">Discussed new requirements and market conditions.</p>
                                <div class="flex items-center space-x-3">
                                    <button class="text-xs text-primary hover:underline">View Call Notes</button>
                                    <button class="text-xs text-primary hover:underline">Schedule Follow-up</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 pt-6 border-t border-[#E6E6E6] text-center">
                        <button class="text-sm text-primary hover:underline font-medium">Load More Communications</button>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-primary">Documents</h3>
                        <button class="text-secondary hover:text-primary text-sm">
                            <i class="fa-solid fa-upload mr-1"></i>
                            Upload Document
                        </button>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 border border-[#E6E6E6] rounded-lg hover:border-primary transition-all-smooth cursor-pointer">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-primary bg-opacity-10 rounded flex items-center justify-center">
                                    <i class="fa-solid fa-file-contract text-primary"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-primary">Agreement Document</div>
                                    <div class="text-xs text-secondary">Signed • 892 KB</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="text-secondary hover:text-primary p-2">
                                    <i class="fa-solid fa-download"></i>
                                </button>
                                <button class="text-secondary hover:text-primary p-2">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-6">
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <h3 class="text-sm font-semibold text-primary uppercase tracking-wider mb-4">Quick Actions</h3>
                    <div class="space-y-2">
                        <button class="w-full flex items-center justify-between px-4 py-3 border border-[#E6E6E6] rounded-lg hover:border-primary hover:bg-muted transition-all-smooth">
                            <div class="flex items-center space-x-3">
                                <i class="fa-solid fa-calendar-plus text-primary"></i>
                                <span class="text-sm text-primary">Book Viewing</span>
                            </div>
                            <i class="fa-solid fa-chevron-right text-secondary text-xs"></i>
                        </button>
                        <button class="w-full flex items-center justify-between px-4 py-3 border border-[#E6E6E6] rounded-lg hover:border-primary hover:bg-muted transition-all-smooth">
                            <div class="flex items-center space-x-3">
                                <i class="fa-solid fa-handshake text-primary"></i>
                                <span class="text-sm text-primary">Create Deal</span>
                            </div>
                            <i class="fa-solid fa-chevron-right text-secondary text-xs"></i>
                        </button>
                        <button class="w-full flex items-center justify-between px-4 py-3 border border-[#E6E6E6] rounded-lg hover:border-primary hover:bg-muted transition-all-smooth">
                            <div class="flex items-center space-x-3">
                                <i class="fa-solid fa-file-invoice-dollar text-primary"></i>
                                <span class="text-sm text-primary">Generate Commission</span>
                            </div>
                            <i class="fa-solid fa-chevron-right text-secondary text-xs"></i>
                        </button>
                        <button class="w-full flex items-center justify-between px-4 py-3 border border-[#E6E6E6] rounded-lg hover:border-primary hover:bg-muted transition-all-smooth">
                            <div class="flex items-center space-x-3">
                                <i class="fa-solid fa-share-nodes text-primary"></i>
                                <span class="text-sm text-primary">Share Properties</span>
                            </div>
                            <i class="fa-solid fa-chevron-right text-secondary text-xs"></i>
                        </button>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-sm font-semibold text-primary uppercase tracking-wider">Performance Metrics</h3>
                        <select class="text-xs border border-[#E6E6E6] rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option>Last 12 Months</option>
                            <option>Last 6 Months</option>
                            <option>Last Quarter</option>
                        </select>
                    </div>
                    <div class="space-y-6">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-secondary uppercase tracking-wider">Referral Volume</span>
                                <span class="text-lg font-semibold text-primary">12</span>
                            </div>
                            <div class="text-xs text-secondary">+3 vs previous period</div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-secondary uppercase tracking-wider">Conversion Rate</span>
                                <span class="text-lg font-semibold text-primary">35%</span>
                            </div>
                            <div class="flex-1 bg-muted rounded-full h-2 mb-1">
                                <div class="bg-primary h-2 rounded-full" style="width: 35%"></div>
                            </div>
                            <div class="text-xs text-secondary">4 of 12 referrals converted</div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-secondary uppercase tracking-wider">Revenue Attribution</span>
                                <span class="text-lg font-semibold text-primary">£245k</span>
                            </div>
                            <div class="text-xs text-secondary">Annual contract value from deals</div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-secondary uppercase tracking-wider">Commission Paid</span>
                                <span class="text-lg font-semibold text-primary">£24.5k</span>
                            </div>
                            <div class="text-xs text-secondary">10% of first year rent</div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-secondary uppercase tracking-wider">Avg Deal Size</span>
                                <span class="text-lg font-semibold text-primary">6,500 sq ft</span>
                            </div>
                            <div class="text-xs text-secondary">Across 4 closed deals</div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-secondary uppercase tracking-wider">Quality Score</span>
                                <span class="text-lg font-semibold text-primary">4.5/5.0</span>
                            </div>
                            <div class="flex items-center space-x-1 mb-1">
                                <i class="fa-solid fa-star text-primary text-xs"></i>
                                <i class="fa-solid fa-star text-primary text-xs"></i>
                                <i class="fa-solid fa-star text-primary text-xs"></i>
                                <i class="fa-solid fa-star text-primary text-xs"></i>
                                <i class="fa-solid fa-star-half-stroke text-primary text-xs"></i>
                            </div>
                            <div class="text-xs text-secondary">Based on referral quality assessment</div>
                        </div>
                    </div>
                    <button class="w-full mt-6 pt-6 border-t border-[#E6E6E6] text-sm text-primary hover:underline font-medium">
                        View Detailed Performance Report
                    </button>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <h3 class="text-sm font-semibold text-primary uppercase tracking-wider mb-4">Linked Entities</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-xs text-secondary uppercase tracking-wider">Units</div>
                                <span class="text-xs font-semibold text-primary">8</span>
                            </div>
                            <div class="space-y-2">
                                <a href="#" class="flex items-center justify-between p-2 border border-[#E6E6E6] rounded hover:border-primary transition-all-smooth">
                                    <span class="text-sm text-primary">Sample Unit</span>
                                    <i class="fa-solid fa-chevron-right text-secondary text-xs"></i>
                                </a>
                                <button class="w-full text-xs text-primary hover:underline text-left">View all 8 units</button>
                            </div>
                        </div>
                        <div class="pt-4 border-t border-[#E6E6E6]">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-xs text-secondary uppercase tracking-wider">Active Deals</div>
                                <span class="text-xs font-semibold text-primary">2</span>
                            </div>
                            <div class="space-y-2">
                                <a href="#" class="flex items-center justify-between p-2 border border-[#E6E6E6] rounded hover:border-primary transition-all-smooth">
                                    <div>
                                        <div class="text-sm text-primary">Active Deal</div>
                                        <div class="text-xs text-secondary">In Progress</div>
                                    </div>
                                    <i class="fa-solid fa-chevron-right text-secondary text-xs"></i>
                                </a>
                                <button class="w-full text-xs text-primary hover:underline text-left">View all 2 deals</button>
                            </div>
                        </div>
                        <div class="pt-4 border-t border-[#E6E6E6]">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-xs text-secondary uppercase tracking-wider">Suppliers</div>
                                <span class="text-xs font-semibold text-primary">0</span>
                            </div>
                            <div class="text-xs text-secondary">No linked suppliers</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <h3 class="text-sm font-semibold text-primary uppercase tracking-wider mb-4">Upcoming Actions</h3>
                    <div class="space-y-3">
                        <div class="flex items-start space-x-3 p-3 bg-muted rounded-lg">
                            <div class="w-8 h-8 bg-primary rounded flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-calendar text-white text-xs"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm font-medium text-primary mb-1">Follow-up Scheduled</div>
                                <div class="text-xs text-secondary mb-2">Property discussion</div>
                                <div class="text-xs text-primary font-medium">Tomorrow at 10:00 AM</div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-muted rounded-lg">
                            <div class="w-8 h-8 bg-primary rounded flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-phone text-white text-xs"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm font-medium text-primary mb-1">Call Reminder</div>
                                <div class="text-xs text-secondary mb-2">Check on requirements</div>
                                <div class="text-xs text-primary font-medium">Friday at 2:00 PM</div>
                            </div>
                        </div>
                    </div>
                    <button class="w-full mt-4 text-sm text-primary hover:underline font-medium">
                        View All Actions
                    </button>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <h3 class="text-sm font-semibold text-primary uppercase tracking-wider mb-4">Relationship Timeline</h3>
                    <div class="space-y-4">
                        <div class="flex items-start space-x-3">
                            <div class="w-2 h-2 bg-primary rounded-full mt-2 flex-shrink-0"></div>
                            <div class="flex-1">
                                <div class="text-xs text-secondary mb-1">Recently</div>
                                <div class="text-sm text-primary font-medium mb-1">New Requirement Added</div>
                                <div class="text-xs text-secondary">Property inquiry</div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <div class="w-2 h-2 bg-primary rounded-full mt-2 flex-shrink-0"></div>
                            <div class="flex-1">
                                <div class="text-xs text-secondary mb-1">Last Month</div>
                                <div class="text-sm text-primary font-medium mb-1">Deal Closed</div>
                                <div class="text-xs text-secondary">Successful placement</div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <div class="w-2 h-2 bg-secondary rounded-full mt-2 flex-shrink-0"></div>
                            <div class="flex-1">
                                <div class="text-xs text-secondary mb-1">3 Months Ago</div>
                                <div class="text-sm text-primary font-medium mb-1">Relationship Established</div>
                                <div class="text-xs text-secondary">Initial contact</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    `;

    const editButton = document.querySelector('#contact-details-content [data-action="edit-contact"]');
    if (editButton) {
        editButton.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            openEditContact(row.dataset.contactId);
        });
    }
    
    document.getElementById('contact-details-overlay').classList.remove('hidden');
    document.getElementById('contact-details-panel').classList.add('open');
    
    // Highlight selected row
    document.querySelectorAll('.contact-row').forEach(r => r.classList.remove('bg-primary', 'bg-opacity-10'));
    row.classList.add('bg-primary', 'bg-opacity-10');
}

function closeContactDetails() {
    document.getElementById('contact-details-overlay').classList.add('hidden');
    document.getElementById('contact-details-panel').classList.remove('open');
    document.querySelectorAll('.contact-row').forEach(r => r.classList.remove('bg-primary', 'bg-opacity-10'));
}

// Store current type filter (from buttons)
// Default to 'Brokers' since that button is active by default
let currentTypeFilter = 'Brokers';

function filterContacts() {
    const firmFilter = document.getElementById('filter-firm').value;
    const submarketFilter = document.getElementById('filter-submarket').value;
    const activityFilter = document.getElementById('filter-activity').value;
    const healthFilter = document.getElementById('filter-health').value;
    
    const contactRows = document.querySelectorAll('.contact-row');
    let visibleCount = 0;
    
    // Map type filter button text to data attribute values
    const typeFilterMap = {
        'all': 'all',
        'Brokers': 'Flex Broker',
        'Disposal Agents': 'Disposal Agent',
        'Traditional Tenant Reps': 'Tenant',
        'Suppliers': 'Supplier'
    };
    
    const typeFilterValue = typeFilterMap[currentTypeFilter] || 'all';
    
    contactRows.forEach(function(row) {
        const contactType = row.dataset.contactType;
        const contactCompany = row.dataset.contactCompany;
        const contactHealth = row.dataset.contactHealth;
        const contactSubmarket = row.dataset.contactSubmarket || '';
        const contactActivityHours = parseInt(row.dataset.contactActivityHours) || 0;
        
        let shouldShow = true;
        
        // Filter by type
        if (typeFilterValue !== 'all' && contactType !== typeFilterValue) {
            shouldShow = false;
        }
        
        // Filter by firm/company
        if (firmFilter !== 'all' && contactCompany !== firmFilter) {
            shouldShow = false;
        }
        
        // Filter by submarket
        if (submarketFilter !== 'all' && contactSubmarket !== submarketFilter) {
            shouldShow = false;
        }
        
        // Filter by health
        if (healthFilter !== 'all' && contactHealth !== healthFilter) {
            shouldShow = false;
        }
        
        // Filter by activity (hours)
        if (activityFilter !== 'all') {
            const hoursLimit = parseInt(activityFilter);
            if (contactActivityHours > hoursLimit) {
                shouldShow = false;
            }
        }
        
        if (shouldShow) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update the count display
    const countDisplay = document.getElementById('contact-count');
    if (countDisplay) {
        const totalContacts = contactsData.length || contactRows.length;
        countDisplay.textContent = `Showing ${visibleCount} of ${totalContacts} contacts`;
    }
}

function clearAllFilters() {
    currentTypeFilter = 'all';
    document.getElementById('filter-firm').value = 'all';
    document.getElementById('filter-submarket').value = 'all';
    document.getElementById('filter-activity').value = 'all';
    document.getElementById('filter-health').value = 'all';
    
    // Reset type filter buttons
    document.querySelectorAll('#page-header button').forEach(function(btn) {
        if (btn.textContent.trim() === 'Brokers' || btn.textContent.trim() === 'Disposal Agents' || 
            btn.textContent.trim() === 'Traditional Tenant Reps' || btn.textContent.trim() === 'Suppliers') {
            btn.classList.remove('text-primary', 'border-primary');
            btn.classList.add('text-secondary', 'border-transparent');
        }
    });
    
    filterContacts();
}

window.addEventListener('load', function() {
    const addContactBtn = document.getElementById('add-contact-btn');
    const modal = document.getElementById('add-contact-modal');
    const closeModal = document.getElementById('close-modal');
    const backButton = document.getElementById('back-button');
    const cancelButton = document.getElementById('cancel-button');
    const saveDraftButton = document.getElementById('save-draft-button');
    const form = document.getElementById('add-contact-form');
    const typeRadios = document.querySelectorAll('input[name="type"]');
    const brokerSection = document.getElementById('broker-specific-section');
    const disposalSection = document.getElementById('disposal-agent-section');
    const supplierSection = document.getElementById('supplier-specific-section');
    const successToast = document.getElementById('success-toast');

    contactModalElements.modal = modal;
    contactModalElements.form = form;
    contactModalElements.modalTitle = document.getElementById('contact-modal-title');
    contactModalElements.modalSubtitle = document.getElementById('contact-modal-subtitle');
    contactModalElements.submitButton = document.querySelector('#form-actions button[type="submit"]');
    contactModalElements.submitLabel = contactModalElements.submitButton?.querySelector('span') || null;
    contactModalElements.successToast = successToast;
    contactModalElements.successToastTitle = document.getElementById('success-toast-title');
    contactModalElements.successToastSubtitle = document.getElementById('success-toast-subtitle');
    contactModalElements.typeRadios = Array.from(typeRadios);
    contactModalElements.brokerSection = brokerSection;
    contactModalElements.disposalSection = disposalSection;
    contactModalElements.supplierSection = supplierSection;

    if (addContactBtn) {
        addContactBtn.addEventListener('click', function() {
            openContactModal('add');
        });
    }

    if (closeModal) {
        closeModal.addEventListener('click', closeContactModal);
    }

    if (backButton) {
        backButton.addEventListener('click', closeContactModal);
    }

    if (cancelButton) {
        cancelButton.addEventListener('click', function() {
            if (confirm('Discard changes and return to contacts list?')) {
                closeContactModal();
            }
        });
    }

    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeContactModal();
            }
        });
    }

    if (typeRadios.length > 0) {
        typeRadios.forEach(function(radio) {
            radio.addEventListener('change', function() {
                setTypeSections(this.value);
            });
        });
    }

    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(form);
            const submitButton = contactModalElements.submitButton;
            const submitLabel = contactModalElements.submitLabel;
            if (submitButton) submitButton.disabled = true;
            if (submitLabel) submitLabel.textContent = 'Saving...';

            const payload = {
                firstName: (formData.get('first_name') || '').toString().trim() || null,
                lastName: (formData.get('last_name') || '').toString().trim(),
                email: (formData.get('email') || '').toString().trim(),
                phone: (formData.get('phone') || '').toString().trim() || null,
                company: (formData.get('company') || '').toString().trim() || null,
                type: TYPE_VALUE_MAP[(formData.get('type') || '').toString()] || null,
                role: (formData.get('role') || '').toString().trim() || null,
            };

            if (!payload.lastName || !payload.email) {
                alert('Last name and email are required.');
                if (submitButton) submitButton.disabled = false;
                if (submitLabel) submitLabel.textContent = isEditingContact ? 'Save Changes' : 'Add Contact';
                return;
            }

            try {
                if (isEditingContact && editingContactId) {
                    await updateContactApi(editingContactId, payload);
                    if (contactModalElements.successToastTitle) {
                        contactModalElements.successToastTitle.textContent = 'Contact updated successfully';
                    }
                    if (contactModalElements.successToastSubtitle) {
                        contactModalElements.successToastSubtitle.textContent = 'CRM record updated and synced.';
                    }
                } else {
                    await createContact(payload);
                    if (contactModalElements.successToastTitle) {
                        contactModalElements.successToastTitle.textContent = 'Contact added successfully';
                    }
                    if (contactModalElements.successToastSubtitle) {
                        contactModalElements.successToastSubtitle.textContent = 'Record created and ready to use.';
                    }
                }

                if (successToast) {
                    successToast.classList.remove('hidden');
                    setTimeout(function() {
                        successToast.classList.add('hidden');
                    }, 2000);
                }
                closeContactModal();
                await fetchContacts(true);
            } catch (error) {
                alert(error.message || 'Failed to save contact. Please try again.');
            } finally {
                if (submitButton) submitButton.disabled = false;
                if (submitLabel) submitLabel.textContent = isEditingContact ? 'Save Changes' : 'Add Contact';
            }
        });
    }

    if (saveDraftButton) {
        saveDraftButton.addEventListener('click', function() {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-8 right-8 bg-secondary text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 z-50';
            toast.innerHTML = '<div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center"><i class="fa-solid fa-save text-white"></i></div><div><div class="font-semibold">Draft saved</div><div class="text-xs opacity-90">You can complete this later</div></div>';
            document.body.appendChild(toast);

            setTimeout(function() {
                toast.remove();
            }, 2500);
        });
    }
    
    attachContactRowHandlers();
    
    // Filter functionality
    const filterFirm = document.getElementById('filter-firm');
    const filterSubmarket = document.getElementById('filter-submarket');
    const filterActivity = document.getElementById('filter-activity');
    const filterHealth = document.getElementById('filter-health');
    const clearFiltersBtn = document.getElementById('clear-filters');
    
    // Type filter buttons
    const typeButtons = document.querySelectorAll('#page-header button');
    typeButtons.forEach(function(btn) {
        const btnText = btn.textContent.trim();
        if (btnText === 'Brokers' || btnText === 'Disposal Agents' || 
            btnText === 'Traditional Tenant Reps' || btnText === 'Suppliers') {
            btn.addEventListener('click', function() {
                // Update button styles
                typeButtons.forEach(function(b) {
                    const bText = b.textContent.trim();
                    if (bText === 'Brokers' || bText === 'Disposal Agents' || 
                        bText === 'Traditional Tenant Reps' || bText === 'Suppliers') {
                        b.classList.remove('text-primary', 'border-primary');
                        b.classList.add('text-secondary', 'border-transparent');
                    }
                });
                
                // Set active button
                if (currentTypeFilter === btnText) {
                    // Toggle off if clicking same button
                    currentTypeFilter = 'all';
                    btn.classList.remove('text-primary', 'border-primary');
                    btn.classList.add('text-secondary', 'border-transparent');
                } else {
                    currentTypeFilter = btnText;
                    btn.classList.remove('text-secondary', 'border-transparent');
                    btn.classList.add('text-primary', 'border-primary');
                }
                
                filterContacts();
            });
        }
    });
    
    if (filterFirm) filterFirm.addEventListener('change', filterContacts);
    if (filterSubmarket) filterSubmarket.addEventListener('change', filterContacts);
    if (filterActivity) filterActivity.addEventListener('change', filterContacts);
    if (filterHealth) filterHealth.addEventListener('change', filterContacts);
    if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', clearAllFilters);
    
    // Company lookup functionality
    const companyInput = document.getElementById('company-input');
    const companyLookupBtn = document.getElementById('company-lookup-btn');
    const companySuggestions = document.getElementById('company-suggestions');
    const companySuggestionsList = document.getElementById('company-suggestions-list');
    
    // Sample company data for prototype
    const sampleCompanies = [
        'Knight Frank',
        'CBRE',
        'JLL',
        'Savills',
        'Cushman & Wakefield',
        'Colliers International',
        'BNP Paribas Real Estate',
        'Avison Young',
        'DTZ',
        'GVA',
        'Lambert Smith Hampton',
        'Gerald Eve',
        'Bidwells',
        'Strutt & Parker',
        'Knight Knox',
        'British Land',
        'Landsec',
        'Derwent London',
        'Great Portland Estates',
        'Shaftesbury'
    ];
    
    function filterCompanies(query) {
        if (!query || query.trim() === '') {
            return sampleCompanies;
        }
        const lowerQuery = query.toLowerCase();
        return sampleCompanies.filter(company => 
            company.toLowerCase().includes(lowerQuery)
        );
    }
    
    function showSuggestions(query) {
        const filtered = filterCompanies(query);
        companySuggestionsList.innerHTML = '';
        
        if (filtered.length === 0) {
            companySuggestionsList.innerHTML = '<div class="px-4 py-2 text-sm text-secondary text-center">No companies found. Type to create a new company.</div>';
        } else {
            filtered.slice(0, 10).forEach(function(company) {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'w-full px-4 py-2 text-left text-sm text-primary hover:bg-muted transition-all-smooth flex items-center space-x-2';
                button.innerHTML = '<i class="fa-solid fa-building text-secondary text-xs"></i><span>' + company + '</span>';
                button.addEventListener('click', function() {
                    companyInput.value = company;
                    companySuggestions.classList.add('hidden');
                    companyInput.focus();
                });
                companySuggestionsList.appendChild(button);
            });
            
            if (filtered.length > 10) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'px-4 py-2 text-xs text-secondary border-t border-[#E6E6E6]';
                moreDiv.textContent = (filtered.length - 10) + ' more companies found';
                companySuggestionsList.appendChild(moreDiv);
            }
        }
        
        companySuggestions.classList.remove('hidden');
    }
    
    function hideSuggestions() {
        companySuggestions.classList.add('hidden');
    }
    
    if (companyInput) {
        companyInput.addEventListener('input', function() {
            showSuggestions(this.value);
        });
        
        companyInput.addEventListener('focus', function() {
            if (this.value) {
                showSuggestions(this.value);
            }
        });
    }
    
    if (companyLookupBtn) {
        companyLookupBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (companySuggestions.classList.contains('hidden')) {
                showSuggestions(companyInput.value || '');
            } else {
                hideSuggestions();
            }
        });
    }
    
    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
        const companySection = document.querySelector('#company-details-section .relative');
        if (companySection && !companySection.contains(e.target)) {
            hideSuggestions();
        }
    });

    fetchContacts();
});
</script>


<script>
    const CONTACTS_API_URL = '/api/contacts';
    let contactsData = [];
    let isFetchingContacts = false;
    
    // TYPE MAPPING (Zoho Value -> Display Logic)
    const TYPE_VALUE_MAP = {
        'Tenant': 'Tenant',
        'Landlord': 'Landlord', 
        'Flex Broker': 'Flex Broker',
        'Agent': 'Agent',
        'Investor': 'Investor',
        'Developer': 'Developer',
        'Solicitor': 'Solicitor',
        'Architect': 'Architect'
    };

    function escapeHtml(text) {
        if (!text) return '';
        return String(text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function formatLastActivity(dateString) {
        if (!dateString) return 'Never';
        const date = new Date(dateString);
        if (isNaN(date)) return 'Never';
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        if (diffInSeconds < 60) return 'Just now';
        if (diffInSeconds < 3600) return Math.floor(diffInSeconds / 60) + ' mins ago';
        if (diffInSeconds < 86400) return Math.floor(diffInSeconds / 3600) + ' hours ago';
        if (diffInSeconds < 604800) return Math.floor(diffInSeconds / 86400) + ' days ago';
        return date.toLocaleDateString();
    }

    function getInitials(name) {
        if (!name) return '?';
        const parts = name.trim().split(/\s+/).filter(Boolean);
        if (parts.length === 0) return '?';
        if (parts.length === 1) return parts[0][0].toUpperCase();
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }

    function getTypeMeta(type) {
        const types = {
            'Tenant': { icon: 'fa-user', bg: 'bg-blue-100', text: 'text-blue-800' },
            'Landlord': { icon: 'fa-building', bg: 'bg-purple-100', text: 'text-purple-800' },
            'Flex Broker': { icon: 'fa-handshake', bg: 'bg-green-100', text: 'text-green-800' },
            'Agent': { icon: 'fa-user-tie', bg: 'bg-orange-100', text: 'text-orange-800' },
            'Investor': { icon: 'fa-chart-line', bg: 'bg-indigo-100', text: 'text-indigo-800' },
            'Developer': { icon: 'fa-hard-hat', bg: 'bg-yellow-100', text: 'text-yellow-800' },
            'Solicitor': { icon: 'fa-gavel', bg: 'bg-red-100', text: 'text-red-800' },
            'Architect': { icon: 'fa-drafting-compass', bg: 'bg-teal-100', text: 'text-teal-800' },
            'Other': { icon: 'fa-user-tag', bg: 'bg-gray-100', text: 'text-gray-800' }
        };
        return types[type] || types['Other'];
    }

    function renderContactsTable(contacts) {
        const tbody = document.getElementById('contacts-table-body');
        if (!tbody) return;

        if (contacts.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="px-6 py-12 text-center text-secondary text-sm">
                        No contacts found.
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = contacts.map(contact => {
            const typeMeta = getTypeMeta(contact.type);
            const initials = getInitials(contact.name);
            
            return `
            <tr class="hover:bg-muted transition-all-smooth cursor-pointer contact-row" 
                onclick="window.location.href='/contacts/${contact.id}'">
                <td class="px-6 py-4" onclick="event.stopPropagation()">
                    <input type="checkbox" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                </td>
                <td class="px-6 py-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-medium text-sm">
                            ${initials}
                        </div>
                        <div>
                            <div class="font-semibold text-primary text-sm">${escapeHtml(contact.name || 'Unnamed')}</div>
                            <div class="text-xs text-secondary">${escapeHtml(contact.role || '-')}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${typeMeta.bg} ${typeMeta.text}">
                        <i class="fa-solid ${typeMeta.icon} mr-1.5"></i>
                        ${escapeHtml(contact.type || 'Other')}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm text-primary">${escapeHtml(contact.company || '-')}</td>
                <td class="px-6 py-4 text-sm text-primary">${escapeHtml(contact.email || '-')}</td>
                <td class="px-6 py-4 text-sm text-secondary">${escapeHtml(contact.phone || '-')}</td>
                <td class="px-6 py-4 text-sm text-secondary">${formatLastActivity(contact.lastActivity)}</td>
                <td class="px-6 py-4">
                    <div class="flex items-center space-x-2">
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-muted text-primary">
                            <i class="fa-solid fa-chart-line mr-1"></i>
                            0 deals
                        </span>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <i class="fa-solid fa-circle mr-1.5 text-[6px]"></i>
                        Active
                    </span>
                </td>
                <td class="px-6 py-4 text-right">
                    <button class="text-secondary hover:text-primary" onclick="event.stopPropagation()">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </button>
                </td>
            </tr>
            `;
        }).join('');
    }

    async function fetchContacts(forceRefresh = false) {
        if (isFetchingContacts && !forceRefresh) return;
        
        const tbody = document.getElementById('contacts-table-body');
        isFetchingContacts = true;
        
        if (tbody && contactsData.length === 0) {
             tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="px-6 py-12 text-center text-secondary text-sm">
                        Loading contacts...
                    </td>
                </tr>
            `;
        }

        try {
            const response = await fetch(`${CONTACTS_API_URL}?page=1&pageSize=100`);
            if (!response.ok) throw new Error('Failed to fetch contacts');
            
            const data = await response.json();
            const items = Array.isArray(data) ? data : (data.items || []);
            
            contactsData = items;
            renderContactsTable(contactsData);
            
        } catch (error) {
            console.error('Error fetching contacts:', error);
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="px-6 py-12 text-center text-red-500 text-sm">
                            Failed to load contacts.
                        </td>
                    </tr>
                `;
            }
        } finally {
            isFetchingContacts = false;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchContacts();
        
        const form = document.getElementById('add-contact-form');
        const successToast = document.getElementById('success-toast'); // Ensure this ID matches or is generic
        const modal = document.getElementById('add-contact-modal');

        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const payload = {
                    firstName: formData.get('first_name')?.toString() || null,
                    lastName: formData.get('last_name')?.toString() || '',
                    email: formData.get('email')?.toString() || '',
                    phone: formData.get('phone')?.toString() || null,
                    company: formData.get('company')?.toString() || null,
                    type: TYPE_VALUE_MAP[(formData.get('type') || '').toString()] || null,
                    role: formData.get('role')?.toString() || null,
                };

                try {
                    await createContact(payload);
                    // Show success logic here (assuming toast exists)
                    alert('Contact created successfully!');
                    form.reset();
                    // Close modal logic if function exists
                    closeContactModal();
                    fetchContacts(true);
                } catch (error) {
                    console.error('Error creating contact:', error);
                    alert('Failed to create contact: ' + error.message);
                }
            });
        }
    });
</script>
</body>
</html>
