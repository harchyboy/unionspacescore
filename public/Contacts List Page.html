<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="union-logo.svg" />
    <title>Contacts</title>
    <script src='https://cdn.tailwindcss.com'></script>
    <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    border: "var(--border)",
                    input: "var(--input)",
                    ring: "var(--ring)",
                    background: "var(--background)",
                    foreground: "var(--foreground)",
                    primary: {
                        DEFAULT: "var(--primary)",
                        foreground: "var(--primary-foreground)",
                    },
                    secondary: {
                        DEFAULT: "var(--secondary)",
                        foreground: "var(--secondary-foreground)",
                    },
                    destructive: {
                        DEFAULT: "var(--destructive)",
                        foreground: "var(--destructive-foreground)",
                    },
                    muted: {
                        DEFAULT: "var(--muted)",
                        foreground: "var(--muted-foreground)",
                    },
                    accent: {
                        DEFAULT: "var(--accent)",
                        foreground: "var(--accent-foreground)",
                    },
                    popover: {
                        DEFAULT: "var(--popover)",
                        foreground: "var(--popover-foreground)",
                    },
                    card: {
                        DEFAULT: "var(--card)",
                        foreground: "var(--card-foreground)",
                    },
                },
                borderRadius: {
                    lg: "var(--radius)",
                    md: "calc(var(--radius) - 2px)",
                    sm: "calc(var(--radius) - 4px)",
                },
                fontFamily: {
                    sans: ["var(--font-sans)"],
                    serif: ["var(--font-serif)"],
                    mono: ["var(--font-mono)"],
                },
                boxShadow: {
                    '2xs': 'var(--shadow-2xs)',
                    'xs': 'var(--shadow-xs)',
                    'sm': 'var(--shadow-sm)',
                    'DEFAULT': 'var(--shadow)',
                    'md': 'var(--shadow-md)',
                    'lg': 'var(--shadow-lg)',
                    'xl': 'var(--shadow-xl)',
                    '2xl': 'var(--shadow-2xl)',
                },
            },
        }
    }
    </script>
    <script>
        window.FontAwesomeConfig = { autoReplaceSvg: 'nest'};
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: #FAFAFA;
            --foreground: #0f172a;
            --card: #ffffff;
            --card-foreground: #0f172a;
            --primary: #252525;
            --primary-foreground: #ffffff;
            --secondary: #8E8E8E;
            --secondary-foreground: #ffffff;
            --muted: #FAFAFA;
            --muted-foreground: #0f172a;
            --accent: #8E8E8E;
            --accent-foreground: #ffffff;
            --destructive: #ef4444;
            --destructive-foreground: #ffffff;
            --border: #E6E6E6;
            --input: #FFFFFF;
            --ring: #94a3b8;
            --font-sans: Inter, sans-serif;
            --font-serif: Georgia, serif;
            --font-mono: JetBrains Mono, monospace;
            --radius: 10px;
            --shadow: -2px 4px 12px 4px rgba(51,51,51,0.05);
        }
        
        ::-webkit-scrollbar { display: none;}
        
        body {
            font-family: var(--font-sans);
            background-color: #F0F0F0;
            color: #252525;
        }
        
        .transition-all-smooth {
            transition: all 0.2s ease-in-out;
        }
        
        .hover-lift:hover {
            transform: translateY(-2px);
        }
        
        .slide-over {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .slide-over.open {
            transform: translateX(0);
        }
        
        .field-group {
            opacity: 0;
            animation: fadeInUp 0.3s ease-out forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .field-group:nth-child(1) { animation-delay: 0.05s; }
        .field-group:nth-child(2) { animation-delay: 0.1s; }
        .field-group:nth-child(3) { animation-delay: 0.15s; }
        .field-group:nth-child(4) { animation-delay: 0.2s; }
        .field-group:nth-child(5) { animation-delay: 0.25s; }
        .field-group:nth-child(6) { animation-delay: 0.3s; }
        .field-group:nth-child(7) { animation-delay: 0.35s; }
        .field-group:nth-child(8) { animation-delay: 0.4s; }
        .field-group:nth-child(9) { animation-delay: 0.45s; }
    </style>
    <script src="sidebar.js" defer></script>
</head>
<body class="antialiased">

<div id="app-shell" class="flex h-screen overflow-hidden">
    
    <aside id="sidebar" class="w-64 bg-white border-r border-[#E6E6E6] flex flex-col" data-sidebar-placeholder data-active="contacts"></aside>
    
    <main id="main-content" class="flex-1 flex flex-col overflow-hidden">
        
        <header id="header" class="bg-white border-b border-[#E6E6E6] px-8 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-6 flex-1">
                <div class="relative flex-1 max-w-xl">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-secondary"></i>
                    <input type="text" placeholder="Search contacts, companies, brokers..." class="w-full pl-11 pr-4 py-2.5 bg-muted border border-[#E6E6E6] rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <button class="relative p-2 text-secondary hover:text-primary transition-all-smooth">
                    <i class="fa-solid fa-bell text-lg"></i>
                    <span class="absolute top-1 right-1 w-2 h-2 bg-destructive rounded-full"></span>
                </button>
                <button class="p-2 text-secondary hover:text-primary transition-all-smooth">
                    <i class="fa-solid fa-question-circle text-lg"></i>
                </button>
            </div>
        </header>
        
        <div id="page-header" class="bg-white border-b border-[#E6E6E6] px-8 py-6">
            <div class="flex items-start justify-between">
                <div>
                    <h1 class="text-3xl font-semibold text-primary mb-2">Contacts</h1>
                    <p class="text-secondary text-sm">Manage brokers, tenants, landlords, and supplier relationships</p>
                </div>
                <button id="add-contact-btn" class="bg-primary text-white px-6 py-2.5 rounded-lg font-medium hover:bg-opacity-90 transition-all-smooth flex items-center space-x-2">
                    <i class="fa-solid fa-plus"></i>
                    <span>Add Contact</span>
                </button>
            </div>
            
            <div class="flex items-center space-x-4 mt-6">
                <button class="px-4 py-2 text-sm font-medium text-primary border-b-2 border-primary">Brokers</button>
                <button class="px-4 py-2 text-sm font-medium text-secondary hover:text-primary border-b-2 border-transparent hover:border-secondary transition-all-smooth">Disposal Agents</button>
                <button class="px-4 py-2 text-sm font-medium text-secondary hover:text-primary border-b-2 border-transparent hover:border-secondary transition-all-smooth">Traditional Tenant Reps</button>
                <button class="px-4 py-2 text-sm font-medium text-secondary hover:text-primary border-b-2 border-transparent hover:border-secondary transition-all-smooth">Suppliers</button>
                <div class="flex-1"></div>
                <button class="text-secondary hover:text-primary text-sm flex items-center space-x-1">
                    <i class="fa-solid fa-filter"></i>
                    <span>Filters</span>
                </button>
                <button class="text-secondary hover:text-primary text-sm flex items-center space-x-1">
                    <i class="fa-solid fa-download"></i>
                    <span>Export</span>
                </button>
            </div>
        </div>
        
        <div id="filters-section" class="bg-white border-b border-[#E6E6E6] px-8 py-4">
            <div class="flex items-center space-x-3 flex-wrap gap-2">
                <div class="relative">
                    <select id="filter-firm" class="appearance-none bg-muted border border-[#E6E6E6] rounded-lg px-4 py-2 pr-8 text-sm text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="all">All Firms</option>
                        <option value="Knight Frank">Knight Frank</option>
                        <option value="CBRE">CBRE</option>
                        <option value="JLL">JLL</option>
                        <option value="Savills">Savills</option>
                        <option value="Cushman & Wakefield">Cushman & Wakefield</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-secondary text-xs pointer-events-none"></i>
                </div>
                
                <div class="relative">
                    <select id="filter-submarket" class="appearance-none bg-muted border border-[#E6E6E6] rounded-lg px-4 py-2 pr-8 text-sm text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="all">All Submarkets</option>
                        <option value="City Core">City Core</option>
                        <option value="Shoreditch">Shoreditch</option>
                        <option value="Mayfair">Mayfair</option>
                        <option value="Canary Wharf">Canary Wharf</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-secondary text-xs pointer-events-none"></i>
                </div>
                
                <div class="relative">
                    <select id="filter-activity" class="appearance-none bg-muted border border-[#E6E6E6] rounded-lg px-4 py-2 pr-8 text-sm text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="all">All Activity</option>
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="365">Last year</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-secondary text-xs pointer-events-none"></i>
                </div>
                
                <div class="relative">
                    <select id="filter-health" class="appearance-none bg-muted border border-[#E6E6E6] rounded-lg px-4 py-2 pr-8 text-sm text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="all">All Relationship Health</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                        <option value="Needs Attention">Needs Attention</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-secondary text-xs pointer-events-none"></i>
                </div>
                
                <button id="clear-filters" class="text-secondary hover:text-primary text-sm ml-2">
                    Clear all
                </button>
            </div>
        </div>
        
        <div id="contacts-list" class="flex-1 overflow-y-auto bg-[#F0F0F0] px-8 py-6">
            <div class="bg-white rounded-lg border border-[#E6E6E6]">
                <div class="overflow-x-visible">
                    <table class="w-full">
                        <thead class="bg-muted border-b border-[#E6E6E6]">
                            <tr>
                                <th class="px-6 py-3 text-left">
                                    <input type="checkbox" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider group relative" style="overflow: visible;">
                                    <div id="name-filter-trigger" class="flex items-center cursor-pointer" onclick="toggleNameFilterMenu(event)">
                                        <span>Contact Name</span>
                                        <div class="flex items-center bg-white border border-[#E6E6E6] rounded px-2 py-0.5 ml-2 hover:border-primary transition-all-smooth">
                                            <span id="current-name-filter-label" class="text-primary font-bold mr-1">All</span>
                                            <i class="fa-solid fa-chevron-down text-[10px] text-secondary"></i>
                                        </div>
                                    </div>
                                    <div id="name-filter-menu" class="hidden absolute left-6 top-8 z-[9999] w-16 max-h-60 overflow-y-auto bg-white border border-[#E6E6E6] rounded-lg shadow-xl py-1" style="box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                                        <!-- Options generated by JS -->
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Company</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Phone</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Open Items</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Health</th>
                                <th class="px-6 py-3 text-right text-xs font-semibold text-secondary uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contacts-table-body" class="divide-y divide-[#E6E6E6]">
                            <tr>
                                <td colspan="9" class="px-6 py-12 text-center text-secondary text-sm">
                                    Loading contacts...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="bulk-actions-bar" class="mt-6 flex items-center justify-between">
                <div id="contact-count" class="text-sm text-secondary">
                    Showing 26 of 26 contacts
                </div>
                <div class="flex items-center space-x-2">
                    <button class="px-4 py-2 border border-[#E6E6E6] rounded-lg text-sm text-primary hover:bg-muted transition-all-smooth flex items-center space-x-2">
                        <i class="fa-solid fa-envelope"></i>
                        <span>Send Email</span>
                    </button>
                    <button class="px-4 py-2 border border-[#E6E6E6] rounded-lg text-sm text-primary hover:bg-muted transition-all-smooth flex items-center space-x-2">
                        <i class="fa-solid fa-tag"></i>
                        <span>Add Tags</span>
                    </button>
                    <button class="px-4 py-2 border border-[#E6E6E6] rounded-lg text-sm text-primary hover:bg-muted transition-all-smooth flex items-center space-x-2">
                        <i class="fa-solid fa-file-export"></i>
                        <span>Export Selected</span>
                    </button>
                </div>
            </div>
            
            <div id="quick-stats" class="mt-8 grid grid-cols-4 gap-6">
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-secondary text-sm font-medium">Total Contacts</div>
                        <i class="fa-solid fa-users text-primary"></i>
                    </div>
                    <div id="total-contacts-count" class="text-3xl font-semibold text-primary">26</div>
                    <div id="total-contacts-change" class="text-xs text-secondary mt-2">+8 this month</div>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-secondary text-sm font-medium">Active Brokers</div>
                        <i class="fa-solid fa-handshake text-primary"></i>
                    </div>
                    <div class="text-3xl font-semibold text-primary">34</div>
                    <div class="text-xs text-secondary mt-2">18 preferred</div>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-secondary text-sm font-medium">Active Tenants</div>
                        <i class="fa-solid fa-user-tie text-primary"></i>
                    </div>
                    <div class="text-3xl font-semibold text-primary">28</div>
                    <div class="text-xs text-secondary mt-2">12 in onboarding</div>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-secondary text-sm font-medium">Avg Response Time</div>
                        <i class="fa-solid fa-clock text-primary"></i>
                    </div>
                    <div class="text-3xl font-semibold text-primary">4.2h</div>
                    <div class="text-xs text-secondary mt-2">-0.8h vs last month</div>
                </div>
            </div>
            
            <div class="mt-8">
                <div id="broker-performance-section" class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-primary">Top Broker Performance</h3>
                        <button class="text-sm text-secondary hover:text-primary">View All</button>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between pb-3 border-b border-[#E6E6E6]">
                            <div class="flex items-center space-x-3">
                                <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=128&h=128&fit=crop&crop=faces" alt="James Parker" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <div class="text-sm font-medium text-primary">James Parker</div>
                                    <div class="text-xs text-secondary">Knight Frank</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-semibold text-primary">£1.2M</div>
                                <div class="text-xs text-secondary">8 conversions</div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between pb-3 border-b border-[#E6E6E6]">
                            <div class="flex items-center space-x-3">
                                <img src="https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=128&h=128&fit=crop&crop=faces" alt="Oliver Martinez" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <div class="text-sm font-medium text-primary">Oliver Martinez</div>
                                    <div class="text-xs text-secondary">JLL</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-semibold text-primary">£890K</div>
                                <div class="text-xs text-secondary">6 conversions</div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between pb-3 border-b border-[#E6E6E6]">
                            <div class="flex items-center space-x-3">
                                <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=128&h=128&fit=crop&crop=faces" alt="Rachel Green" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <div class="text-sm font-medium text-primary">Rachel Green</div>
                                    <div class="text-xs text-secondary">Savills</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-semibold text-primary">£750K</div>
                                <div class="text-xs text-secondary">5 conversions</div>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <img src="https://images.unsplash.com/photo-1519085360753-af0119f7cbe7?w=128&h=128&fit=crop&crop=faces" alt="Tom Anderson" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <div class="text-sm font-medium text-primary">Tom Anderson</div>
                                    <div class="text-xs text-secondary">CBRE</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-semibold text-primary">£620K</div>
                                <div class="text-xs text-secondary">4 conversions</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="recent-activity" class="mt-8">
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <h3 class="text-lg font-semibold text-primary mb-6">Recent Activity</h3>
                    <div class="space-y-4">
                        <div class="flex items-start space-x-4 pb-4 border-b border-[#E6E6E6]">
                            <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-envelope text-white text-xs"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm text-primary font-medium">Email logged with James Parker</div>
                                <div class="text-xs text-secondary mt-1">Viewing scheduled for 99 Bishopsgate - 3rd floor suite</div>
                                <div class="text-xs text-secondary mt-1">2 hours ago</div>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-4 pb-4 border-b border-[#E6E6E6]">
                            <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-user-plus text-white text-xs"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm text-primary font-medium">New contact added</div>
                                <div class="text-xs text-secondary mt-1">Emma Wilson from CleanPro Services added as Supplier</div>
                                <div class="text-xs text-secondary mt-1">5 hours ago</div>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-4 pb-4 border-b border-[#E6E6E6]">
                            <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-phone text-white text-xs"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm text-primary font-medium">Call logged with Sarah Chen</div>
                                <div class="text-xs text-secondary mt-1">Discussed floorplan updates for Principal Place</div>
                                <div class="text-xs text-secondary mt-1">1 day ago</div>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-4">
                            <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-handshake text-white text-xs"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm text-primary font-medium">Deal closed with Michael Roberts</div>
                                <div class="text-xs text-secondary mt-1">TechCorp Ltd signed for The Leadenhall Building</div>
                                <div class="text-xs text-secondary mt-1">3 days ago</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="communication-insights" class="mt-8">
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <h3 class="text-lg font-semibold text-primary mb-6">Communication Insights</h3>
                    <div class="grid grid-cols-3 gap-6">
                        <div class="text-center">
                            <div class="text-3xl font-semibold text-primary mb-2">284</div>
                            <div class="text-sm text-secondary">Emails This Month</div>
                            <div class="text-xs text-green-600 mt-1">+12% vs last month</div>
                        </div>
                        <div class="text-center border-l border-r border-[#E6E6E6]">
                            <div class="text-3xl font-semibold text-primary mb-2">127</div>
                            <div class="text-sm text-secondary">Calls Logged</div>
                            <div class="text-xs text-green-600 mt-1">+8% vs last month</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-semibold text-primary mb-2">45</div>
                            <div class="text-sm text-secondary">Meetings Scheduled</div>
                            <div class="text-xs text-red-600 mt-1">-3% vs last month</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </main>
</div>

<!-- Contact Details Slide-Over Panel -->
<div id="contact-details-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50" onclick="closeContactDetails()"></div>
<div id="contact-details-panel" class="slide-over fixed right-0 top-0 bottom-0 w-5/6 max-w-7xl bg-white shadow-2xl z-50 overflow-y-auto">
    <div id="contact-details-content">
        <div class="text-center py-12 text-secondary">
            <i class="fa-solid fa-user text-4xl mb-4"></i>
            <p>Select a contact to view details</p>
        </div>
    </div>
</div>

<div id="add-contact-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
    <div class="min-h-screen bg-[#F0F0F0]">
        <div class="bg-white border-b border-[#E6E6E6] px-8 py-4 sticky top-0 z-10">
            <div class="max-w-4xl mx-auto flex items-center justify-between">
                <button id="back-button" class="flex items-center space-x-2 text-secondary hover:text-primary transition-all-smooth">
                    <i class="fa-solid fa-arrow-left"></i>
                    <span class="text-sm font-medium">Back to Contacts</span>
                </button>
                <button id="close-modal" class="text-secondary hover:text-primary p-2">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <div class="bg-white border-b border-[#E6E6E6] px-8 py-6">
            <div class="max-w-4xl mx-auto">
                <h1 id="contact-modal-title" class="text-3xl font-semibold text-primary mb-2">Add Contact</h1>
                <p id="contact-modal-subtitle" class="text-secondary text-sm">Expand your network. Fill in the details below to create a new contact record.</p>
            </div>
        </div>
        
        <div class="px-8 py-8">
            <div class="max-w-4xl mx-auto">
                <form id="add-contact-form" class="space-y-8">
                    <div id="contact-type-section" class="bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Contact Type</h2>
                            <p class="text-sm text-secondary">Define the relationship and role of this contact</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="relative flex flex-col items-center justify-center px-6 py-6 border-2 border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth bg-muted">
                                <input type="radio" name="type" value="flex-broker" class="sr-only peer" required>
                                <i class="fa-solid fa-handshake text-3xl text-secondary peer-checked:text-primary mb-3"></i>
                                <span class="text-sm font-semibold text-secondary peer-checked:text-primary">Brokers</span>
                                <span class="text-xs text-secondary mt-1">Tenant representative</span>
                                <div class="absolute inset-0 border-2 border-transparent peer-checked:border-primary rounded-lg pointer-events-none"></div>
                            </label>
                            <label class="relative flex flex-col items-center justify-center px-6 py-6 border-2 border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth bg-muted">
                                <input type="radio" name="type" value="disposal-agent" class="sr-only peer">
                                <i class="fa-solid fa-building text-3xl text-secondary peer-checked:text-primary mb-3"></i>
                                <span class="text-sm font-semibold text-secondary peer-checked:text-primary">Disposal Agents</span>
                                <span class="text-xs text-secondary mt-1">Landlord representative</span>
                                <div class="absolute inset-0 border-2 border-transparent peer-checked:border-primary rounded-lg pointer-events-none"></div>
                            </label>
                            <label class="relative flex flex-col items-center justify-center px-6 py-6 border-2 border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth bg-muted">
                                <input type="radio" name="type" value="tenant" class="sr-only peer">
                                <i class="fa-solid fa-user-tie text-3xl text-secondary peer-checked:text-primary mb-3"></i>
                                <span class="text-sm font-semibold text-secondary peer-checked:text-primary">Traditional Tenant Reps</span>
                                <span class="text-xs text-secondary mt-1">Occupier contact</span>
                                <div class="absolute inset-0 border-2 border-transparent peer-checked:border-primary rounded-lg pointer-events-none"></div>
                            </label>
                            <label class="relative flex flex-col items-center justify-center px-6 py-6 border-2 border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth bg-muted">
                                <input type="radio" name="type" value="supplier" class="sr-only peer">
                                <i class="fa-solid fa-wrench text-3xl text-secondary peer-checked:text-primary mb-3"></i>
                                <span class="text-sm font-semibold text-secondary peer-checked:text-primary">Suppliers</span>
                                <span class="text-xs text-secondary mt-1">Service provider</span>
                                <div class="absolute inset-0 border-2 border-transparent peer-checked:border-primary rounded-lg pointer-events-none"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div id="personal-details-section" class="bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Personal Details</h2>
                            <p class="text-sm text-secondary">Basic contact information</p>
                        </div>
                        <div class="space-y-6">
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold text-primary mb-2">First Name <span class="text-destructive">*</span></label>
                                    <input type="text" name="first_name" required class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="John">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-primary mb-2">Last Name <span class="text-destructive">*</span></label>
                                    <input type="text" name="last_name" required class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="Smith">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Role / Title</label>
                                <input type="text" name="role" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="e.g., Partner, Director, Head of Property">
                            </div>
                        </div>
                    </div>
                    
                    <div id="company-details-section" class="bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Company Details</h2>
                            <p class="text-sm text-secondary">Organisation and firm information</p>
                        </div>
                        <div class="space-y-6">
                            <div class="relative">
                                <label class="block text-sm font-semibold text-primary mb-2">Company Name <span class="text-destructive">*</span></label>
                                <div class="relative">
                                    <input type="hidden" id="company-id-input" name="company_id">
                                    <input type="text" id="company-input" name="company" required class="w-full px-4 py-3 pr-12 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="e.g., Knight Frank, CBRE, JLL">
                                    <button type="button" id="company-lookup-btn" class="absolute right-4 top-1/2 transform -translate-y-1/2 p-1.5 text-secondary hover:text-primary transition-all-smooth rounded hover:bg-muted" title="Search existing companies" style="margin-top: 0;">
                                        <i class="fa-solid fa-ellipsis-vertical text-sm"></i>
                                    </button>
                                </div>
                                <div id="company-suggestions" class="hidden absolute z-50 w-full mt-1 bg-white border border-[#E6E6E6] rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                    <div class="py-1" id="company-suggestions-list">
                                        <!-- Suggestions will be populated here -->
                                    </div>
                                </div>
                                <p class="text-xs text-secondary mt-2">If the firm doesn't exist, we'll create it automatically</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">City / Region</label>
                                <input type="text" name="city" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="London">
                            </div>
                        </div>
                    </div>
                    
                    <div id="contact-information-section" class="bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Contact Information</h2>
                            <p class="text-sm text-secondary">How to reach this contact</p>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Email Address <span class="text-destructive">*</span></label>
                                <input type="email" name="email" required class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="john.smith@example.com">
                                <p class="text-xs text-secondary mt-2">Primary email for all communications</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Phone Number</label>
                                <input type="tel" name="phone" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="+44 20 1234 5678">
                            </div>
                        </div>
                    </div>
                    
                    <div id="broker-specific-section" class="hidden bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Broker Details</h2>
                            <p class="text-sm text-secondary">Additional information for broker contacts</p>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Brokerage Territory</label>
                                <input type="text" name="territory" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="e.g., City Core, West End">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Specialisms</label>
                                <input type="text" name="specialisms" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="e.g., Tech, Finance, Creative">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Preferred Submarkets</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <label class="flex items-center space-x-2 px-4 py-3 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                        <input type="checkbox" name="submarket" value="city-core" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                        <span class="text-sm text-primary">City Core</span>
                                    </label>
                                    <label class="flex items-center space-x-2 px-4 py-3 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                        <input type="checkbox" name="submarket" value="shoreditch" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                        <span class="text-sm text-primary">Shoreditch</span>
                                    </label>
                                    <label class="flex items-center space-x-2 px-4 py-3 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                        <input type="checkbox" name="submarket" value="mayfair" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                        <span class="text-sm text-primary">Mayfair</span>
                                    </label>
                                    <label class="flex items-center space-x-2 px-4 py-3 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                        <input type="checkbox" name="submarket" value="canary-wharf" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                        <span class="text-sm text-primary">Canary Wharf</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Referral Source</label>
                                <input type="text" name="referral_source" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="How did this broker find UNION?">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Commission Structure</label>
                                <textarea name="commission_notes" rows="2" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="Reference notes on commission agreement"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div id="disposal-agent-section" class="hidden bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Disposal Agent Details</h2>
                            <p class="text-sm text-secondary">Additional information for disposal agent contacts</p>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Landlord Roster</label>
                                <input type="text" name="landlord_roster" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="e.g., British Land, Landsec, Derwent">
                                <p class="text-xs text-secondary mt-2">Comma-separated list of landlords this agent represents</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Instruction Types</label>
                                <div class="grid grid-cols-3 gap-3">
                                    <label class="flex items-center space-x-2 px-4 py-3 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                        <input type="checkbox" name="instruction_type" value="cat-a" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                        <span class="text-sm text-primary">Cat A</span>
                                    </label>
                                    <label class="flex items-center space-x-2 px-4 py-3 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                        <input type="checkbox" name="instruction_type" value="cat-a-plus" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                        <span class="text-sm text-primary">Cat A+</span>
                                    </label>
                                    <label class="flex items-center space-x-2 px-4 py-3 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                        <input type="checkbox" name="instruction_type" value="fitted" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                        <span class="text-sm text-primary">Fitted</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="supplier-specific-section" class="hidden bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Supplier Details</h2>
                            <p class="text-sm text-secondary">Service provider information</p>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Service Category</label>
                                <select name="service_category" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth appearance-none">
                                    <option value="">Select category</option>
                                    <option value="cleaning">Cleaning</option>
                                    <option value="av">AV & Technology</option>
                                    <option value="it">IT Support</option>
                                    <option value="maintenance">Repairs & Maintenance</option>
                                    <option value="plants">Plants & Greenery</option>
                                    <option value="coffee">Coffee & Beverages</option>
                                    <option value="furniture">Furniture</option>
                                    <option value="utilities">Utilities</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Coverage Areas</label>
                                <input type="text" name="coverage_areas" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="e.g., Central London, EC1-EC4">
                            </div>
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold text-primary mb-2">Rate Card (£/hour)</label>
                                    <input type="number" name="rate_card" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="50">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-primary mb-2">Lead Time (days)</label>
                                    <input type="number" name="lead_time" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="3">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="relationship-section" class="bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Relationship & Notes</h2>
                            <p class="text-sm text-secondary">Context for future interactions</p>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Relationship Notes</label>
                                <textarea name="relationship_notes" rows="4" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth" placeholder="Add context about this relationship—how you met, communication preferences, past interactions..."></textarea>
                                <p class="text-xs text-secondary mt-2">This helps shape tone and approach in future communications</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="preferences-section" class="bg-white rounded-lg border border-[#E6E6E6] p-8 field-group">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-primary mb-1">Communication Preferences</h2>
                            <p class="text-sm text-secondary">How this contact prefers to engage</p>
                        </div>
                        <div class="space-y-4">
                            <label class="flex items-start space-x-3 p-4 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                <input type="checkbox" name="email_logging" class="w-5 h-5 text-primary border-[#E6E6E6] rounded focus:ring-primary mt-0.5">
                                <div class="flex-1">
                                    <span class="text-sm font-semibold text-primary block">Email logging consent</span>
                                    <span class="text-xs text-secondary mt-1 block">Automatically associate emails with this contact's record</span>
                                </div>
                            </label>
                            <label class="flex items-start space-x-3 p-4 border border-[#E6E6E6] rounded-lg cursor-pointer hover:border-primary transition-all-smooth">
                                <input type="checkbox" name="confidential_requirement" class="w-5 h-5 text-primary border-[#E6E6E6] rounded focus:ring-primary mt-0.5">
                                <div class="flex-1">
                                    <span class="text-sm font-semibold text-primary block">Confidential requirement flag</span>
                                    <span class="text-xs text-secondary mt-1 block">This broker typically works with confidential tenant identities</span>
                                </div>
                            </label>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Communication Cadence</label>
                                <select name="updates_cadence" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth appearance-none">
                                    <option value="weekly">Weekly updates</option>
                                    <option value="fortnightly">Fortnightly updates</option>
                                    <option value="monthly" selected>Monthly updates</option>
                                    <option value="on-demand">On-demand only</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-primary mb-2">Contact Status</label>
                                <select name="status" class="w-full px-4 py-3 border border-[#E6E6E6] rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-smooth appearance-none">
                                    <option value="active" selected>Active</option>
                                    <option value="do-not-contact">Do not contact</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="form-actions" class="flex items-center justify-between pt-6 field-group">
                        <button type="button" id="cancel-button" class="px-8 py-3 border-2 border-[#E6E6E6] text-primary rounded-lg font-semibold hover:bg-muted transition-all-smooth">
                            Cancel
                        </button>
                        <div class="flex items-center space-x-4">
                            <button type="button" id="save-draft-button" class="px-8 py-3 border-2 border-primary text-primary rounded-lg font-semibold hover:bg-muted transition-all-smooth">
                                Save Draft
                            </button>
                            <button type="submit" class="px-8 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-opacity-90 transition-all-smooth flex items-center space-x-2">
                                <span>Add Contact</span>
                                <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="success-toast" class="hidden fixed bottom-8 right-8 bg-primary text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 z-50">
    <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
        <i class="fa-solid fa-check text-white"></i>
    </div>
    <div>
        <div id="success-toast-title" class="font-semibold">Contact added successfully</div>
        <div id="success-toast-subtitle" class="text-xs opacity-90">Record created and ready to use</div>
    </div>
</div>

<script>
const CONTACTS_API_URL = '/api/contacts';
let contactsData = [];
let isFetchingContacts = false;

const CONTACT_TYPE_META = {
    'Flex Broker': { label: 'Brokers', displayLabel: 'Broker', icon: 'fa-handshake', badgeClass: 'bg-primary text-white' },
    'Disposal Agent': { label: 'Disposal Agents', icon: 'fa-building', badgeClass: 'bg-secondary text-white' },
    Tenant: { label: 'Traditional Tenant Reps', icon: 'fa-user-tie', badgeClass: 'bg-accent text-white' },
    Supplier: { label: 'Supplier', icon: 'fa-wrench', badgeClass: 'bg-muted text-primary' },
    Landlord: { label: 'Landlord', icon: 'fa-landmark', badgeClass: 'bg-muted text-primary' },
    default: { label: 'Contact', icon: 'fa-user', badgeClass: 'bg-muted text-primary' },
};

const HEALTH_BADGES = {
    Excellent: 'bg-green-100 text-green-800',
    Good: 'bg-green-100 text-green-800',
    Fair: 'bg-yellow-100 text-yellow-800',
    'Needs Attention': 'bg-red-100 text-red-800',
};

const TYPE_VALUE_MAP = {
    'flex-broker': 'Flex Broker',
    'disposal-agent': 'Disposal Agent',
    tenant: 'Tenant',
    supplier: 'Supplier',
};

const TYPE_LABEL_TO_VALUE = {
    'Flex Broker': 'flex-broker',
    Broker: 'flex-broker',
    'Disposal Agent': 'disposal-agent',
    Tenant: 'tenant',
    Supplier: 'supplier',
};

let isEditingContact = false;
let editingContactId = null;

const contactModalElements = {
    modal: null,
    form: null,
    modalTitle: null,
    modalSubtitle: null,
    submitButton: null,
    submitLabel: null,
    successToast: null,
    successToastTitle: null,
    successToastSubtitle: null,
    typeRadios: [],
    brokerSection: null,
    disposalSection: null,
    supplierSection: null,
};

function normalizeContactsResponse(data) {
    if (!data) return [];
    if (Array.isArray(data.items)) return data.items;
    if (Array.isArray(data.contacts)) return data.contacts;
    if (Array.isArray(data.data)) return data.data;
    return [];
}

function escapeHtml(value) {
    if (!value) return '';
    return value.replace(/[&<>"']/g, function(match) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return map[match];
    });
}

function formatLastActivity(hours) {
    if (hours === null || hours === undefined || Number.isNaN(hours)) return '—';
    if (hours < 1) return 'Just now';
    if (hours < 24) return `${hours} hour${hours === 1 ? '' : 's'} ago`;
    const days = Math.floor(hours / 24);
    return `${days} day${days === 1 ? '' : 's'} ago`;
}

function setTypeSections(value) {
    const { brokerSection, disposalSection, supplierSection } = contactModalElements;
    if (brokerSection) brokerSection.classList.add('hidden');
    if (disposalSection) disposalSection.classList.add('hidden');
    if (supplierSection) supplierSection.classList.add('hidden');

    if (value === 'flex-broker' && brokerSection) {
        brokerSection.classList.remove('hidden');
    } else if (value === 'disposal-agent' && disposalSection) {
        disposalSection.classList.remove('hidden');
    } else if (value === 'supplier' && supplierSection) {
        supplierSection.classList.remove('hidden');
    }
}

function selectContactType(value) {
    if (!contactModalElements.typeRadios.length) return;
    contactModalElements.typeRadios.forEach(function(radio) {
        radio.checked = value ? radio.value === value : false;
    });
    setTypeSections(value);
}

async function fetchContactById(id) {
    const response = await fetch(`${CONTACTS_API_URL}/${id}?_t=${new Date().getTime()}`);
    if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.message || 'Failed to load contact');
    }
    return response.json();
}

async function updateContactApi(id, payload) {
    const response = await fetch(`${CONTACTS_API_URL}/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
    });

    if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.message || 'Failed to update contact');
    }

    return response.json();
}

function closeContactModal() {
    const { modal, form } = contactModalElements;
    if (modal) {
        modal.classList.add('hidden');
    }
    document.body.style.overflow = '';
    if (form) {
        form.reset();
    }
    isEditingContact = false;
    editingContactId = null;
    selectContactType(null);
}

function populateContactForm(contactData) {
    const { form } = contactModalElements;
    if (!form || !contactData) return;

    const firstNameInput = form.querySelector('input[name="first_name"]');
    const lastNameInput = form.querySelector('input[name="last_name"]');
    const emailInput = form.querySelector('input[name="email"]');
    const phoneInput = form.querySelector('input[name="phone"]');
    const companyInput = form.querySelector('input[name="company"]');
    const companyIdInput = form.querySelector('input[name="company_id"]');
    const roleInput = form.querySelector('input[name="role"]');

    if (firstNameInput) firstNameInput.value = contactData.firstName || '';
    if (lastNameInput) lastNameInput.value = contactData.lastName || '';
    if (emailInput) emailInput.value = contactData.email || '';
    if (phoneInput) phoneInput.value = contactData.phone || contactData.mobile || '';
    if (companyInput) companyInput.value = contactData.company || '';
    if (companyIdInput) companyIdInput.value = contactData.accountId || '';
    if (roleInput) roleInput.value = contactData.role || '';

    const typeValue = TYPE_LABEL_TO_VALUE[contactData.type] || 'flex-broker';
    selectContactType(typeValue);
}

    window.toggleActionMenu = function(id) {
        const menu = document.getElementById(`action-menu-${id}`);
        if (!menu) return;
        
        // Close all other menus
        document.querySelectorAll('[id^="action-menu-"]').forEach(el => {
            if (el.id !== `action-menu-${id}`) el.classList.add('hidden');
        });
        
        menu.classList.toggle('hidden');
        
        // Close menu when clicking outside
        const closeMenu = (e) => {
            if (!menu.contains(e.target) && !e.target.closest('.action-btn')) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeMenu);
            }
        };
        setTimeout(() => {
             document.addEventListener('click', closeMenu);
        }, 0);
    };

    window.handleEditClick = function(id) {
        const contact = contactsData.find(c => c.id === id);
        if (!contact) return;
        
        openContactModal('edit', contact);
        // Close menu
        const menu = document.getElementById(`action-menu-${id}`);
        if (menu) menu.classList.add('hidden');
    };

    window.handleDeleteClick = async function(id) {
        if (!confirm('Are you sure you want to delete this contact? This action cannot be undone.')) return;
        
        try {
            const response = await fetch(`/api/contacts/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Failed to delete contact');
            
            fetchContacts(true);
            // Close menu
            const menu = document.getElementById(`action-menu-${id}`);
            if (menu) menu.classList.add('hidden');
        } catch (error) {
            alert('Error deleting contact: ' + error.message);
        }
    };
    
    window.openContactModal = function(mode = 'add', contactData = null) {
        const {
            modal,
            form,
            modalTitle,
            modalSubtitle,
            submitLabel,
        } = contactModalElements;

        if (!modal || !form) return;

        isEditingContact = mode === 'edit';
        editingContactId = isEditingContact && contactData ? contactData.id : null;

        if (modalTitle) modalTitle.textContent = isEditingContact ? 'Edit Contact' : 'Add Contact';
        if (modalSubtitle) {
            modalSubtitle.textContent = isEditingContact
                ? 'Update the details below to keep this record accurate.'
                : 'Expand your network. Fill in the details below to create a new contact record.';
        }
        if (submitLabel) submitLabel.textContent = isEditingContact ? 'Save Changes' : 'Add Contact';

        if (!isEditingContact || !contactData) {
            form.reset();
            selectContactType(null);
        } else {
            populateContactForm(contactData);
        }

        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    async function openEditContact(contactId) {
        if (!contactId) return;
        try {
            const contact = await fetchContactById(contactId);
            window.openContactModal('edit', contact);
        } catch (error) {
            alert(error.message || 'Failed to load contact details.');
        }
    }

function getTypeMeta(type) {
    return CONTACT_TYPE_META[type] || CONTACT_TYPE_META.default;
}

function renderContactsTable(contacts) {
    const tbody = document.getElementById('contacts-table-body');
    if (!tbody) return;

    contactsData = contacts;

    const totalContactsCountEl = document.getElementById('total-contacts-count');
    const totalContactsChangeEl = document.getElementById('total-contacts-change');
    if (totalContactsCountEl) {
        const brokerCount = contacts.filter((contact) => {
            const type = (contact.type || '').toLowerCase();
            return type.includes('broker');
        }).length;
        totalContactsCountEl.textContent = brokerCount.toString();
    }
    if (totalContactsChangeEl) {
        totalContactsChangeEl.textContent = 'Brokers synced from Zoho CRM';
    }

    if (!contacts || contacts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="px-6 py-12 text-center text-secondary text-sm">
                    No contacts found
                </td>
            </tr>
        `;
        filterContacts();
        return;
    }

    const rowsHtml = contacts
        .map((contact) => {
            const rawName = contact.name || 'Unnamed Contact';
            const safeName = escapeHtml(rawName);
            const isBroker = contact.type === 'Flex Broker' || contact.type === 'flex-broker' || contact.type === 'Broker';
            const safeRole = isBroker ? '—' : escapeHtml(contact.role || '—');
            const safeCompany = escapeHtml(contact.company || '—');
            const safeEmail = escapeHtml(contact.email || '—');
            const phoneValue = contact.phone || contact.mobile || '';
            const mobileValue = contact.mobile || '';
            const safePhone = escapeHtml(phoneValue || '—');
            const typeMeta = getTypeMeta(contact.type);
            const typeLabel = typeMeta.displayLabel || typeMeta.label;
            const health = contact.health || 'Good';
            const healthBadge = HEALTH_BADGES[health] || 'bg-muted text-primary';
            const lastActivity = formatLastActivity(contact.lastActivityHours);
            const activityValue =
                contact.lastActivityHours === null || contact.lastActivityHours === undefined
                    ? 9999
                    : contact.lastActivityHours;
            const initials =
                rawName
                    .split(/\s+/)
                    .filter(Boolean)
                    .map((part) => part[0])
                    .join('')
                    .slice(0, 2)
                    .toUpperCase() || 'UN';

            return `
            <tr class="hover:bg-muted transition-all-smooth cursor-pointer contact-row"
                data-contact-id="${contact.id || ''}"
                data-contact-name="${safeName}"
                data-contact-role="${safeRole}"
                data-contact-type="${contact.type || ''}"
                data-contact-company="${safeCompany}"
                data-contact-email="${safeEmail}"
                data-contact-phone="${escapeHtml(contact.phone || '')}"
                data-contact-mobile="${escapeHtml(contact.mobile || '')}"
                data-contact-health="${health}"
                data-contact-activity-hours="${activityValue}"
                data-contact-submarket="${contact.submarket || ''}">
                <td class="px-6 py-4" onclick="event.stopPropagation()">
                    <input type="checkbox" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                </td>
                <td class="px-6 py-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-muted border border-[#E6E6E6] flex items-center justify-center text-primary font-semibold">
                            ${initials}
                        </div>
                        <div>
                            <div class="font-semibold text-primary text-sm">${safeName}</div>
                            <div class="text-xs text-secondary">${lastActivity}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${typeMeta.badgeClass}">
                        <i class="fa-solid ${typeMeta.icon} mr-1.5"></i>
                        ${typeLabel}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm text-primary">${safeCompany}</td>
                <td class="px-6 py-4 text-sm text-primary">${safeEmail}</td>
                <td class="px-6 py-4 text-sm text-secondary">${safePhone}</td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-muted text-primary">
                        <i class="fa-solid fa-chart-line mr-1"></i>
                        Not tracked
                    </span>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${healthBadge}">
                        <i class="fa-solid fa-circle mr-1.5 text-[6px]"></i>
                        ${health}
                    </span>
                </td>
                <td class="px-6 py-4 text-right">
                    <button class="text-secondary hover:text-primary">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </button>
                </td>
            </tr>
            `;
        })
        .join('');

    tbody.innerHTML = rowsHtml;
    attachContactRowHandlers();
    filterContacts();
}

async function fetchContacts(force = false) {
    if (isFetchingContacts && !force) return;
    isFetchingContacts = true;

    const tbody = document.getElementById('contacts-table-body');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="px-6 py-12 text-center text-secondary text-sm">
                    Loading contacts…
                </td>
            </tr>
        `;
    }

    try {
        const response = await fetch(CONTACTS_API_URL);
        if (!response.ok) {
            throw new Error('Unable to load contacts');
        }
        const data = await response.json();
        if (data.source === 'zoho_failed') {
            throw new Error('Zoho CRM returned an empty result. Please verify the integration credentials.');
        }
        const contacts = normalizeContactsResponse(data);
        renderContactsTable(contacts);
    } catch (error) {
        console.error(error);
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="px-6 py-12 text-center text-destructive text-sm">
                        Failed to load contacts. Please try again later.
                    </td>
                </tr>
            `;
        }
    } finally {
        isFetchingContacts = false;
    }
}

async function createContact(payload) {
    const response = await fetch(CONTACTS_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
    });

    if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.message || 'Failed to create contact');
    }

    return response.json();
}

function attachContactRowHandlers() {
    document.querySelectorAll('.contact-row').forEach(function(row) {
        if (row.dataset.clickBound === 'true') return;
        row.dataset.clickBound = 'true';
        row.addEventListener('click', function(e) {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON' && !e.target.closest('button')) {
                showContactDetails(row);
            }
        });
    });
}
function showContactDetails(contactOrRow) {
    let contactData = {};
    
    if (contactOrRow.dataset) {
        // It's a row element
        contactData = {
            id: contactOrRow.dataset.contactId,
            name: contactOrRow.dataset.contactName,
            role: contactOrRow.dataset.contactRole,
            type: contactOrRow.dataset.contactType,
            company: contactOrRow.dataset.contactCompany,
            email: contactOrRow.dataset.contactEmail,
            phone: contactOrRow.dataset.contactPhone,
            mobile: contactOrRow.dataset.contactMobile,
            avatar: contactOrRow.dataset.contactAvatar,
            confidential: contactOrRow.dataset.contactConfidential === 'true',
            health: contactOrRow.dataset.contactHealth || 'Good',
            // Add other fields if needed for display
        };
    } else {
        // It's a contact object
        contactData = contactOrRow;
        // Map object properties if they differ from display expectations
        if (!contactData.health) contactData.health = 'Good';
        // Ensure name is populated if missing (e.g. direct API fetch might not have it at top level if structure differs)
        if (!contactData.name && (contactData.firstName || contactData.lastName)) {
             contactData.name = `${contactData.firstName || ''} ${contactData.lastName || ''}`.trim();
        }
    }

    const { 
        id: contactId, name, role, type: rawType, company, email, 
        phone, mobile, avatar, confidential, health 
    } = contactData;

    const isBroker = rawType === 'Flex Broker' || rawType === 'flex-broker' || rawType === 'Broker';
    const type = isBroker ? 'Broker' : rawType;
    
    const typeColors = {
        'Broker': 'bg-primary text-white',
        'Flex Broker': 'bg-primary text-white',
        'Disposal Agent': 'bg-secondary text-white',
        'Tenant': 'bg-accent text-white',
        'Landlord': 'bg-muted text-primary',
        'Supplier': 'bg-muted text-primary'
    };
    
    const typeIcon = {
        'Flex Broker': 'fa-handshake',
        'Disposal Agent': 'fa-building',
        'Tenant': 'fa-user-tie',
        'Landlord': 'fa-landmark',
        'Supplier': 'fa-wrench'
    };
    
    // Generate initials for avatar fallback
    const displayName = name || 'Unnamed Contact';
    const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase();
    
    document.getElementById('contact-details-content').innerHTML = `
        <div class="bg-white border-b border-[#E6E6E6] px-8 py-6 mb-0">
            <div class="flex items-center space-x-4 mb-4">
                <button onclick="closeContactDetails()" class="text-secondary hover:text-primary transition-all-smooth">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div class="flex items-center space-x-4 flex-1">
                    ${avatar ? `
                    <img src="${avatar}" alt="${name}" class="w-16 h-16 rounded-full object-cover">
                    ` : `
                    <div class="w-16 h-16 bg-muted border border-[#E6E6E6] rounded-full flex items-center justify-center text-primary text-2xl font-semibold">
                        ${initials}
                    </div>
                    `}
                    <div>
                        <div class="flex items-center space-x-3 mb-1">
                            <h1 class="text-2xl font-semibold text-primary">${name}</h1>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${typeColors[type] || 'bg-muted text-primary'}">
                                ${type}
                            </span>
                            ${confidential ? '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-800"><i class="fa-solid fa-lock mr-1"></i>Confidential</span>' : ''}
                        </div>
                        <div class="flex items-center space-x-4 text-sm text-secondary">
                            <span class="flex items-center space-x-1">
                                <i class="fa-solid fa-building"></i>
                                <span>${company}</span>
                            </span>
                            ${isBroker ? `
                            <span class="flex items-center space-x-1">
                                <i class="fa-solid fa-map-marker-alt"></i>
                                <span>City Core, Shoreditch</span>
                            </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="bg-primary text-white px-5 py-2.5 rounded-lg font-medium hover:bg-opacity-90 transition-all-smooth flex items-center space-x-2">
                        <i class="fa-solid fa-envelope"></i>
                        <span>New Email</span>
                    </button>
                    <button class="border border-[#E6E6E6] text-primary px-5 py-2.5 rounded-lg font-medium hover:bg-muted transition-all-smooth flex items-center space-x-2">
                        <i class="fa-solid fa-phone"></i>
                        <span>Log Call</span>
                    </button>
                    <button class="border border-[#E6E6E6] text-primary px-5 py-2.5 rounded-lg font-medium hover:bg-muted transition-all-smooth flex items-center space-x-2">
                        <i class="fa-solid fa-calendar"></i>
                        <span>Create Viewing</span>
                    </button>
                    <button class="border border-[#E6E6E6] text-primary px-5 py-2.5 rounded-lg font-medium hover:bg-muted transition-all-smooth flex items-center space-x-2">
                        <i class="fa-solid fa-plus"></i>
                        <span>Add to Deal</span>
                    </button>
                    <button class="p-2.5 text-secondary hover:text-primary transition-all-smooth">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <button class="px-4 py-2 text-sm font-medium text-primary border-b-2 border-primary">Overview</button>
                <button class="px-4 py-2 text-sm font-medium text-secondary hover:text-primary border-b-2 border-transparent hover:border-secondary transition-all-smooth">Relationship Graph</button>
                <button class="px-4 py-2 text-sm font-medium text-secondary hover:text-primary border-b-2 border-transparent hover:border-secondary transition-all-smooth">Performance</button>
                <button class="px-4 py-2 text-sm font-medium text-secondary hover:text-primary border-b-2 border-transparent hover:border-secondary transition-all-smooth">Communications</button>
                <button class="px-4 py-2 text-sm font-medium text-secondary hover:text-primary border-b-2 border-transparent hover:border-secondary transition-all-smooth">Documents</button>
            </div>
        </div>
        
        <div class="bg-[#F0F0F0] p-8">
        
        <div class="grid grid-cols-3 gap-6">
            <div class="col-span-2 space-y-6">
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-primary">Contact Information</h3>
                        <button type="button" class="text-secondary hover:text-primary text-sm" onclick="openEditContact('${contactId}')">
                            <i class="fa-solid fa-pencil mr-1"></i>
                            Edit
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Email</label>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-primary">${email}</span>
                                <button class="text-secondary hover:text-primary">
                                    <i class="fa-solid fa-copy text-xs"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Phone</label>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-primary">${phone && phone.trim() ? phone : '—'}</span>
                                ${phone && phone.trim() ? `
                                <button class="text-secondary hover:text-primary">
                                    <i class="fa-solid fa-copy text-xs"></i>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Mobile</label>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-primary">${mobile && mobile.trim() ? mobile : '—'}</span>
                                ${mobile && mobile.trim() ? `
                                <button class="text-secondary hover:text-primary">
                                    <i class="fa-solid fa-copy text-xs"></i>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${!isBroker ? `
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Role</label>
                            <span class="text-sm text-primary">${role}</span>
                        </div>
                        ` : ''}
                        
                        ${isBroker ? `
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Territory</label>
                            <span class="text-sm text-primary">—</span>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Specialisms</label>
                            <div class="flex flex-wrap gap-2">
                                <span class="text-sm text-primary">—</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Preferred Submarkets</label>
                            <span class="text-sm text-primary">—</span>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Referral Source</label>
                            <span class="text-sm text-primary">—</span>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Commission Structure</label>
                            <span class="text-sm text-primary">—</span>
                        </div>
                        ` : ''}
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Relationship Health</label>
                            <div class="flex items-center space-x-2">
                                <div class="flex-1 bg-muted rounded-full h-2">
                                    <div class="bg-primary h-2 rounded-full" style="width: ${health === 'Excellent' ? '85%' : health === 'Good' ? '70%' : health === 'Fair' ? '50%' : '30%'}"></div>
                                </div>
                                <span class="text-xs text-secondary">${health}</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Last Contacted</label>
                            <span class="text-sm text-primary">Recently</span>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-[#E6E6E6]">
                        <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-2">Relationship Notes</label>
                        <p class="text-sm text-primary leading-relaxed">—</p>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-[#E6E6E6]">
                        <label class="block text-xs font-medium text-secondary uppercase tracking-wider mb-3">Comms Preferences</label>
                        <div class="flex items-center space-x-6">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" checked class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                                <span class="text-sm text-primary">Email logging consent</span>
                            </label>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-secondary">Updates cadence:</span>
                                <select class="text-sm border border-[#E6E6E6] rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option>Weekly</option>
                                    <option>Bi-weekly</option>
                                    <option>Monthly</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${confidential ? `
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <h3 class="text-lg font-semibold text-primary">Confidential Requirements</h3>
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-destructive text-white">
                                <i class="fa-solid fa-lock mr-1"></i>
                                Confidential
                            </span>
                        </div>
                        <button class="text-secondary hover:text-primary text-sm">
                            <i class="fa-solid fa-plus mr-1"></i>
                            Add Requirement
                        </button>
                    </div>
                    <div class="text-sm text-secondary text-center py-4">
                        No confidential requirements at this time.
                    </div>
                </div>
                ` : ''}
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-primary">Communications History</h3>
                        <div class="flex items-center space-x-2">
                            <div class="relative">
                                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-secondary text-sm"></i>
                                <input type="text" placeholder="Search communications..." class="pl-9 pr-4 py-2 border border-[#E6E6E6] rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <select class="border border-[#E6E6E6] rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                                <option>All Types</option>
                                <option>Email</option>
                                <option>Call</option>
                                <option>Meeting</option>
                                <option>Note</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="text-sm text-secondary text-center py-4">
                            No communications found.
                        </div>
                    </div>
                    <div class="mt-6 pt-6 border-t border-[#E6E6E6] text-center">
                        <button class="text-sm text-primary hover:underline font-medium">Load More Communications</button>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-primary">Documents</h3>
                        <button class="text-secondary hover:text-primary text-sm">
                            <i class="fa-solid fa-upload mr-1"></i>
                            Upload Document
                        </button>
                    </div>
                    <div class="space-y-3">
                        <div class="text-sm text-secondary text-center py-4">
                            No documents found.
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-6">
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <h3 class="text-sm font-semibold text-primary uppercase tracking-wider mb-4">Quick Actions</h3>
                    <div class="space-y-2">
                        <button class="w-full flex items-center justify-between px-4 py-3 border border-[#E6E6E6] rounded-lg hover:border-primary hover:bg-muted transition-all-smooth">
                            <div class="flex items-center space-x-3">
                                <i class="fa-solid fa-calendar-plus text-primary"></i>
                                <span class="text-sm text-primary">Book Viewing</span>
                            </div>
                            <i class="fa-solid fa-chevron-right text-secondary text-xs"></i>
                        </button>
                        <button class="w-full flex items-center justify-between px-4 py-3 border border-[#E6E6E6] rounded-lg hover:border-primary hover:bg-muted transition-all-smooth">
                            <div class="flex items-center space-x-3">
                                <i class="fa-solid fa-handshake text-primary"></i>
                                <span class="text-sm text-primary">Create Deal</span>
                            </div>
                            <i class="fa-solid fa-chevron-right text-secondary text-xs"></i>
                        </button>
                        <button class="w-full flex items-center justify-between px-4 py-3 border border-[#E6E6E6] rounded-lg hover:border-primary hover:bg-muted transition-all-smooth">
                            <div class="flex items-center space-x-3">
                                <i class="fa-solid fa-file-invoice-dollar text-primary"></i>
                                <span class="text-sm text-primary">Generate Commission</span>
                            </div>
                            <i class="fa-solid fa-chevron-right text-secondary text-xs"></i>
                        </button>
                        <button class="w-full flex items-center justify-between px-4 py-3 border border-[#E6E6E6] rounded-lg hover:border-primary hover:bg-muted transition-all-smooth">
                            <div class="flex items-center space-x-3">
                                <i class="fa-solid fa-share-nodes text-primary"></i>
                                <span class="text-sm text-primary">Share Properties</span>
                            </div>
                            <i class="fa-solid fa-chevron-right text-secondary text-xs"></i>
                        </button>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-sm font-semibold text-primary uppercase tracking-wider">Performance Metrics</h3>
                        <select class="text-xs border border-[#E6E6E6] rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option>Last 12 Months</option>
                            <option>Last 6 Months</option>
                            <option>Last Quarter</option>
                        </select>
                    </div>
                    <div class="space-y-6">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-secondary uppercase tracking-wider">Referral Volume</span>
                                <span class="text-lg font-semibold text-primary">—</span>
                            </div>
                            <div class="text-xs text-secondary">— vs previous period</div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-secondary uppercase tracking-wider">Conversion Rate</span>
                                <span class="text-lg font-semibold text-primary">—</span>
                            </div>
                            <div class="flex-1 bg-muted rounded-full h-2 mb-1">
                                <div class="bg-primary h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="text-xs text-secondary">— referrals converted</div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-secondary uppercase tracking-wider">Revenue Attribution</span>
                                <span class="text-lg font-semibold text-primary">—</span>
                            </div>
                            <div class="text-xs text-secondary">Annual contract value from deals</div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-secondary uppercase tracking-wider">Commission Paid</span>
                                <span class="text-lg font-semibold text-primary">—</span>
                            </div>
                            <div class="text-xs text-secondary">— of first year rent</div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-secondary uppercase tracking-wider">Avg Deal Size</span>
                                <span class="text-lg font-semibold text-primary">—</span>
                            </div>
                            <div class="text-xs text-secondary">Across — closed deals</div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-secondary uppercase tracking-wider">Quality Score</span>
                                <span class="text-lg font-semibold text-primary">—</span>
                            </div>
                            <div class="flex items-center space-x-1 mb-1">
                                <i class="fa-regular fa-star text-secondary text-xs"></i>
                                <i class="fa-regular fa-star text-secondary text-xs"></i>
                                <i class="fa-regular fa-star text-secondary text-xs"></i>
                                <i class="fa-regular fa-star text-secondary text-xs"></i>
                                <i class="fa-regular fa-star text-secondary text-xs"></i>
                            </div>
                            <div class="text-xs text-secondary">Based on referral quality assessment</div>
                        </div>
                    </div>
                    <button class="w-full mt-6 pt-6 border-t border-[#E6E6E6] text-sm text-primary hover:underline font-medium">
                        View Detailed Performance Report
                    </button>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <h3 class="text-sm font-semibold text-primary uppercase tracking-wider mb-4">Linked Entities</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-xs text-secondary uppercase tracking-wider">Units</div>
                                <span class="text-xs font-semibold text-primary">—</span>
                            </div>
                            <div class="text-xs text-secondary">No linked units</div>
                        </div>
                        <div class="pt-4 border-t border-[#E6E6E6]">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-xs text-secondary uppercase tracking-wider">Active Deals</div>
                                <span class="text-xs font-semibold text-primary">—</span>
                            </div>
                            <div class="text-xs text-secondary">No active deals</div>
                        </div>
                        <div class="pt-4 border-t border-[#E6E6E6]">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-xs text-secondary uppercase tracking-wider">Suppliers</div>
                                <span class="text-xs font-semibold text-primary">—</span>
                            </div>
                            <div class="text-xs text-secondary">No linked suppliers</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <h3 class="text-sm font-semibold text-primary uppercase tracking-wider mb-4">Upcoming Actions</h3>
                    <div class="space-y-3">
                        <div class="text-sm text-secondary text-center py-4">
                            No upcoming actions.
                        </div>
                    </div>
                    <button class="w-full mt-4 text-sm text-primary hover:underline font-medium">
                        View All Actions
                    </button>
                </div>
                
                <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
                    <h3 class="text-sm font-semibold text-primary uppercase tracking-wider mb-4">Relationship Timeline</h3>
                    <div class="space-y-4">
                        <div class="text-sm text-secondary text-center py-4">
                            No timeline events.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    `;

    // Event listener for Edit button is now handled inline by onclick attribute in HTML generation
    /*
    const editButton = document.querySelector('#contact-details-content [data-action="edit-contact"]');
    if (editButton) {
        editButton.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            const contactId = row.dataset.contactId;
            if (contactId) {
                 openEditContact(contactId);
            }
        });
    }
    */
    
    document.getElementById('contact-details-overlay').classList.remove('hidden');
    document.getElementById('contact-details-panel').classList.add('open');
    
    // Highlight selected row if it exists in DOM (it might not if we passed a raw object)
    if (contactOrRow.dataset) {
        document.querySelectorAll('.contact-row').forEach(r => r.classList.remove('bg-primary', 'bg-opacity-10'));
        contactOrRow.classList.add('bg-primary', 'bg-opacity-10');
        // Store the current contact ID on the panel for easy refresh
        document.getElementById('contact-details-panel').dataset.currentContactId = contactId;
    } else {
        // If passed an object, try to find the row to highlight
        const row = document.querySelector(`.contact-row[data-contact-id="${contactId}"]`);
        if (row) {
    document.querySelectorAll('.contact-row').forEach(r => r.classList.remove('bg-primary', 'bg-opacity-10'));
    row.classList.add('bg-primary', 'bg-opacity-10');
        }
        document.getElementById('contact-details-panel').dataset.currentContactId = contactId;
    }
}

function refreshOpenDetailsPanel(contacts) {
    const panel = document.getElementById('contact-details-panel');
    if (panel && panel.classList.contains('open')) {
        const currentId = panel.dataset.currentContactId;
        if (currentId) {
            const updatedContact = contacts.find(c => c.id === currentId);
            if (updatedContact) {
                showContactDetails(updatedContact);
            }
        }
    }
}

function closeContactDetails() {
    document.getElementById('contact-details-overlay').classList.add('hidden');
    document.getElementById('contact-details-panel').classList.remove('open');
    document.querySelectorAll('.contact-row').forEach(r => r.classList.remove('bg-primary', 'bg-opacity-10'));
}

// Store current type filter (from buttons)
// Default to 'Brokers' since that button is active by default
let currentTypeFilter = 'Brokers';

function filterContacts() {
    const firmFilter = document.getElementById('filter-firm').value;
    const submarketFilter = document.getElementById('filter-submarket').value;
    const activityFilter = document.getElementById('filter-activity').value;
    const healthFilter = document.getElementById('filter-health').value;
    
    const contactRows = document.querySelectorAll('.contact-row');
    let visibleCount = 0;
    
    // Map type filter button text to data attribute values
    const typeFilterMap = {
        'all': 'all',
        'Brokers': 'Flex Broker',
        'Disposal Agents': 'Disposal Agent',
        'Traditional Tenant Reps': 'Tenant',
        'Suppliers': 'Supplier'
    };
    
    const typeFilterValue = typeFilterMap[currentTypeFilter] || 'all';
    
    contactRows.forEach(function(row) {
        const contactType = row.dataset.contactType;
        const contactCompany = row.dataset.contactCompany;
        const contactHealth = row.dataset.contactHealth;
        const contactSubmarket = row.dataset.contactSubmarket || '';
        const contactActivityHours = parseInt(row.dataset.contactActivityHours) || 0;
        
        let shouldShow = true;
        
        // Filter by type
        if (typeFilterValue !== 'all' && contactType !== typeFilterValue) {
            shouldShow = false;
        }
        
        // Filter by firm/company
        if (firmFilter !== 'all' && contactCompany !== firmFilter) {
            shouldShow = false;
        }
        
        // Filter by submarket
        if (submarketFilter !== 'all' && contactSubmarket !== submarketFilter) {
            shouldShow = false;
        }
        
        // Filter by health
        if (healthFilter !== 'all' && contactHealth !== healthFilter) {
            shouldShow = false;
        }
        
        // Filter by activity (hours)
        if (activityFilter !== 'all') {
            const hoursLimit = parseInt(activityFilter);
            if (contactActivityHours > hoursLimit) {
                shouldShow = false;
            }
        }
        
        if (shouldShow) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update the count display
    const countDisplay = document.getElementById('contact-count');
    if (countDisplay) {
        const totalContacts = contactsData.length || contactRows.length;
        countDisplay.textContent = `Showing ${visibleCount} of ${totalContacts} contacts`;
    }
}

function clearAllFilters() {
    currentTypeFilter = 'all';
    document.getElementById('filter-firm').value = 'all';
    document.getElementById('filter-submarket').value = 'all';
    document.getElementById('filter-activity').value = 'all';
    document.getElementById('filter-health').value = 'all';
    
    // Reset type filter buttons
    document.querySelectorAll('#page-header button').forEach(function(btn) {
        if (btn.textContent.trim() === 'Brokers' || btn.textContent.trim() === 'Disposal Agents' || 
            btn.textContent.trim() === 'Traditional Tenant Reps' || btn.textContent.trim() === 'Suppliers') {
            btn.classList.remove('text-primary', 'border-primary');
            btn.classList.add('text-secondary', 'border-transparent');
        }
    });
    
    filterContacts();
}

window.addEventListener('load', function() {
    const addContactBtn = document.getElementById('add-contact-btn');
    const modal = document.getElementById('add-contact-modal');
    const closeModal = document.getElementById('close-modal');
    const backButton = document.getElementById('back-button');
    const cancelButton = document.getElementById('cancel-button');
    const saveDraftButton = document.getElementById('save-draft-button');
    const form = document.getElementById('add-contact-form');
    const typeRadios = document.querySelectorAll('input[name="type"]');
    const brokerSection = document.getElementById('broker-specific-section');
    const disposalSection = document.getElementById('disposal-agent-section');
    const supplierSection = document.getElementById('supplier-specific-section');
    const successToast = document.getElementById('success-toast');

    contactModalElements.modal = modal;
    contactModalElements.form = form;
    contactModalElements.modalTitle = document.getElementById('contact-modal-title');
    contactModalElements.modalSubtitle = document.getElementById('contact-modal-subtitle');
    contactModalElements.submitButton = document.querySelector('#form-actions button[type="submit"]');
    contactModalElements.submitLabel = contactModalElements.submitButton?.querySelector('span') || null;
    contactModalElements.successToast = successToast;
    contactModalElements.successToastTitle = document.getElementById('success-toast-title');
    contactModalElements.successToastSubtitle = document.getElementById('success-toast-subtitle');
    contactModalElements.typeRadios = Array.from(typeRadios);
    contactModalElements.brokerSection = brokerSection;
    contactModalElements.disposalSection = disposalSection;
    contactModalElements.supplierSection = supplierSection;
    
    if (addContactBtn) {
        addContactBtn.addEventListener('click', function() {
            openContactModal('add');
        });
    }
    
    if (closeModal) {
        closeModal.addEventListener('click', closeContactModal);
    }
    
    if (backButton) {
        backButton.addEventListener('click', closeContactModal);
    }
    
    if (cancelButton) {
        cancelButton.addEventListener('click', function() {
            if (confirm('Discard changes and return to contacts list?')) {
                closeContactModal();
            }
        });
    }
    
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeContactModal();
            }
        });
    }
    
    if (typeRadios.length > 0) {
        typeRadios.forEach(function(radio) {
            radio.addEventListener('change', function() {
                setTypeSections(this.value);
            });
        });
    }
    
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(form);
            const submitButton = contactModalElements.submitButton;
            const submitLabel = contactModalElements.submitLabel;
            if (submitButton) submitButton.disabled = true;
            if (submitLabel) submitLabel.textContent = 'Saving...';

            const payload = {
                firstName: (formData.get('first_name') || '').toString().trim() || null,
                lastName: (formData.get('last_name') || '').toString().trim(),
                email: (formData.get('email') || '').toString().trim(),
                phone: (formData.get('phone') || '').toString().trim() || null,
                company: (formData.get('company') || '').toString().trim() || null,
                companyCity: (formData.get('city') || '').toString().trim() || null,
                accountId: (formData.get('company_id') || '').toString().trim() || null,
                type: TYPE_VALUE_MAP[(formData.get('type') || '').toString()] || null,
                role: (formData.get('role') || '').toString().trim() || null,
            };

            if (!payload.lastName || !payload.email) {
                alert('Last name and email are required.');
                if (submitButton) submitButton.disabled = false;
                if (submitLabel) submitLabel.textContent = isEditingContact ? 'Save Changes' : 'Add Contact';
                return;
            }

            try {
                if (isEditingContact && editingContactId) {
                    const updatedContact = await updateContactApi(editingContactId, payload);
                    if (contactModalElements.successToastTitle) {
                        contactModalElements.successToastTitle.textContent = 'Contact updated successfully';
                    }
                    if (contactModalElements.successToastSubtitle) {
                        contactModalElements.successToastSubtitle.textContent = 'CRM record updated and synced.';
                    }
                    // Immediately refresh the open details panel with the returned contact
                    const panel = document.getElementById('contact-details-panel');
                    if (panel && panel.classList.contains('open') && panel.dataset.currentContactId === editingContactId && updatedContact) {
                        showContactDetails(updatedContact);
                    }
                } else {
                    await createContact(payload);
                    if (contactModalElements.successToastTitle) {
                        contactModalElements.successToastTitle.textContent = 'Contact added successfully';
                    }
                    if (contactModalElements.successToastSubtitle) {
                        contactModalElements.successToastSubtitle.textContent = 'Record created and ready to use.';
                    }
                }

                if (successToast) {
                    successToast.classList.remove('hidden');
                    setTimeout(function() {
                    successToast.classList.add('hidden');
            }, 2000);
                }
                closeContactModal();
                
                // Show updating state
                if (isEditingContact && editingContactId) {
                    const panel = document.getElementById('contact-details-panel');
                    if (panel && panel.classList.contains('open') && panel.dataset.currentContactId === editingContactId) {
                        // Optional: Show a loading indicator inside the panel?
                    }
                }

                await fetchContacts(true);
            } catch (error) {
                alert(error.message || 'Failed to save contact. Please try again.');
            } finally {
                if (submitButton) submitButton.disabled = false;
                if (submitLabel) submitLabel.textContent = isEditingContact ? 'Save Changes' : 'Add Contact';
            }
        });
    }
    
    if (saveDraftButton) {
        saveDraftButton.addEventListener('click', function() {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-8 right-8 bg-secondary text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 z-50';
            toast.innerHTML = '<div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center"><i class="fa-solid fa-save text-white"></i></div><div><div class="font-semibold">Draft saved</div><div class="text-xs opacity-90">You can complete this later</div></div>';
            document.body.appendChild(toast);
            
            setTimeout(function() {
                toast.remove();
            }, 2500);
        });
    }
    
    attachContactRowHandlers();
    
    // Filter functionality
    const filterFirm = document.getElementById('filter-firm');
    const filterSubmarket = document.getElementById('filter-submarket');
    const filterActivity = document.getElementById('filter-activity');
    const filterHealth = document.getElementById('filter-health');
    const clearFiltersBtn = document.getElementById('clear-filters');
    
    // Type filter buttons
    const typeButtons = document.querySelectorAll('#page-header button');
    typeButtons.forEach(function(btn) {
        const btnText = btn.textContent.trim();
        if (btnText === 'Brokers' || btnText === 'Disposal Agents' || 
            btnText === 'Traditional Tenant Reps' || btnText === 'Suppliers') {
            btn.addEventListener('click', function() {
                // Update button styles
                typeButtons.forEach(function(b) {
                    const bText = b.textContent.trim();
                    if (bText === 'Brokers' || bText === 'Disposal Agents' || 
                        bText === 'Traditional Tenant Reps' || bText === 'Suppliers') {
                        b.classList.remove('text-primary', 'border-primary');
                        b.classList.add('text-secondary', 'border-transparent');
                    }
                });
                
                // Set active button
                if (currentTypeFilter === btnText) {
                    // Toggle off if clicking same button
                    currentTypeFilter = 'all';
                    btn.classList.remove('text-primary', 'border-primary');
                    btn.classList.add('text-secondary', 'border-transparent');
                } else {
                    currentTypeFilter = btnText;
                    btn.classList.remove('text-secondary', 'border-transparent');
                    btn.classList.add('text-primary', 'border-primary');
                }
                
                filterContacts();
            });
        }
    });
    
    if (filterFirm) filterFirm.addEventListener('change', filterContacts);
    if (filterSubmarket) filterSubmarket.addEventListener('change', filterContacts);
    if (filterActivity) filterActivity.addEventListener('change', filterContacts);
    if (filterHealth) filterHealth.addEventListener('change', filterContacts);
    if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', clearAllFilters);
    
    // Company lookup functionality
    const companyInput = document.getElementById('company-input');
    const companyIdInput = document.getElementById('company-id-input');
    const companyLookupBtn = document.getElementById('company-lookup-btn');
    const companySuggestions = document.getElementById('company-suggestions');
    const companySuggestionsList = document.getElementById('company-suggestions-list');
    const cityInput = document.querySelector('input[name="city"]');
    let companySearchTimeout = null;

    function hideSuggestions() {
        companySuggestions.classList.add('hidden');
    }

    function setSelectedCompany(account) {
        if (!companyInput) return;
        companyInput.value = account.name;
        if (companyIdInput) companyIdInput.value = account.id || '';
        if (cityInput && !cityInput.value && account.city) {
            cityInput.value = account.city;
        }
        hideSuggestions();
    }

    async function fetchCompanies(query) {
        const trimmed = (query || '').trim();
        const searchParam = trimmed.length >= 2 ? `?search=${encodeURIComponent(trimmed)}` : '';
        const response = await fetch(`/api/accounts${searchParam}`);
        if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.message || 'Unable to load companies');
        }
        const data = await response.json();
        return data.items || [];
    }

    async function createCompany(name) {
        const response = await fetch('/api/accounts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name,
                city: cityInput?.value || undefined,
            }),
        });
        if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.message || 'Failed to create company');
        }
        return response.json();
    }

    async function showSuggestions(query) {
        if (!companySuggestionsList) return;
        const trimmed = (query || '').trim();
        companySuggestionsList.innerHTML = '<div class="px-4 py-2 text-sm text-secondary text-center">Searching...</div>';
        companySuggestions.classList.remove('hidden');

        try {
            const results = await fetchCompanies(trimmed);
        companySuggestionsList.innerHTML = '';
        
            if (results.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'px-4 py-2 text-sm text-secondary text-center';
                emptyState.textContent = 'No companies found. You can add a new company below.';
                companySuggestionsList.appendChild(emptyState);
        } else {
                results.slice(0, 10).forEach((account) => {
                const button = document.createElement('button');
                button.type = 'button';
                    button.className = 'w-full flex items-center justify-between px-4 py-2 text-sm text-primary hover:bg-muted transition-all-smooth';
                    button.innerHTML = `<span class="flex items-center space-x-2"><i class="fa-solid fa-building text-secondary text-xs"></i><span>${account.name}</span></span><span class="text-xs text-secondary">${account.city || ''}</span>`;
                    button.addEventListener('click', () => setSelectedCompany(account));
                companySuggestionsList.appendChild(button);
            });
            }

            if (trimmed && trimmed.length >= 2) {
                const addButton = document.createElement('button');
                addButton.type = 'button';
                addButton.className = 'w-full flex items-center space-x-2 px-4 py-2 text-sm text-primary border-t border-[#F0F0F0] hover:bg-muted transition-all-smooth';
                addButton.innerHTML = `<i class="fa-solid fa-plus text-secondary text-xs"></i><span>Add "${trimmed}" as a new company</span>`;
                addButton.addEventListener('click', async () => {
                    addButton.disabled = true;
                    addButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-secondary text-xs"></i><span>Creating company...</span>';
                    try {
                        const account = await createCompany(trimmed);
                        setSelectedCompany(account);
                    } catch (error) {
                        alert(error.message || 'Failed to create company.');
                        addButton.disabled = false;
                        addButton.innerHTML = `<i class="fa-solid fa-plus text-secondary text-xs"></i><span>Add "${trimmed}" as a new company</span>`;
                    }
                });
                companySuggestionsList.appendChild(addButton);
            }
        } catch (error) {
            companySuggestionsList.innerHTML = `<div class="px-4 py-2 text-sm text-destructive text-center">${error.message || 'Unable to load companies.'}</div>`;
        }
    }
    
    if (companyInput) {
        companyInput.addEventListener('input', function () {
            const value = this.value.trim();
            if (companyIdInput) companyIdInput.value = '';
            if (companySearchTimeout) clearTimeout(companySearchTimeout);
            if (!value) {
                hideSuggestions();
                return;
            }
            companySearchTimeout = setTimeout(() => showSuggestions(value), 250);
        });

        companyInput.addEventListener('focus', function () {
            const value = this.value.trim();
            if (value) {
                showSuggestions(value);
            }
        });
    }
    
    if (companyLookupBtn && companyInput) {
        companyLookupBtn.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            const value = companyInput.value.trim();
            if (companySuggestions.classList.contains('hidden')) {
                showSuggestions(value);
            } else {
                hideSuggestions();
            }
        });
    }
    
    document.addEventListener('click', function (e) {
        const companySection = document.querySelector('#company-details-section');
        if (companySection && !companySection.contains(e.target)) {
            hideSuggestions();
        }
    });

    fetchContacts();
});
</script>


<script>
    const CONTACTS_API_URL = '/api/contacts';
    let contactsData = [];
    let isFetchingContacts = false;
    let currentNameFilter = 'All';

    window.toggleNameFilterMenu = function(e) {
        e.stopPropagation();
        e.preventDefault();
        console.log('Toggle name filter menu clicked');
        const menu = document.getElementById('name-filter-menu');
        if (menu) {
            menu.classList.toggle('hidden');
        }
    };

    window.setNameFilter = function(filter) {
        // e might be undefined if called without event, but usually via onclick
        const e = window.event;
        if (e) {
             e.stopPropagation();
             e.preventDefault();
        }
        console.log('Setting filter to:', filter);
        currentNameFilter = filter;
        const label = document.getElementById('current-name-filter-label');
        if (label) label.textContent = filter;
        
        const menu = document.getElementById('name-filter-menu');
        if (menu) menu.classList.add('hidden');
        
        applyFilters();
    };

    function applyFilters() {
        let filtered = [...contactsData];
        
        if (currentNameFilter !== 'All') {
            filtered = filtered.filter(c => {
                const name = c.name || c.firstName || '';
                return name.trim().toUpperCase().startsWith(currentNameFilter);
            });
        }
        
        renderContactsTable(filtered);
    }

    function generateNameFilterOptions() {
        const menu = document.getElementById('name-filter-menu');
        if (!menu) return;

        menu.innerHTML = `
            <button onclick="setNameFilter('All')" class="w-full text-left px-3 py-1.5 text-sm text-primary hover:bg-[#F5F5F5] font-semibold">All</button>
        `;

        for (let i = 65; i <= 90; i++) {
            const letter = String.fromCharCode(i);
            const btn = document.createElement('button');
            btn.className = 'w-full text-left px-3 py-1.5 text-sm text-primary hover:bg-[#F5F5F5]';
            btn.textContent = letter;
            btn.setAttribute('onclick', `setNameFilter('${letter}')`);
            menu.appendChild(btn);
        }
    }

    // Global click handler to close menu
    document.addEventListener('click', function(e) {
        const menu = document.getElementById('name-filter-menu');
        const toggle = e.target.closest('[onclick*="toggleNameFilterMenu"]');
        if (menu && !menu.classList.contains('hidden') && !toggle && !menu.contains(e.target)) {
            menu.classList.add('hidden');
        }
    });
    
    // TYPE MAPPING (Zoho Value -> Display Logic)
    const TYPE_VALUE_MAP = {
        'Tenant': 'Tenant',
        'Landlord': 'Landlord', 
        'Flex Broker': 'Flex Broker',
        'Agent': 'Agent',
        'Investor': 'Investor',
        'Developer': 'Developer',
        'Solicitor': 'Solicitor',
        'Architect': 'Architect'
    };

    function escapeHtml(text) {
        if (!text) return '';
        return String(text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function formatLastActivity(dateString) {
        if (!dateString) return 'Never';
        const date = new Date(dateString);
        if (isNaN(date)) return 'Never';
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        if (diffInSeconds < 60) return 'Just now';
        if (diffInSeconds < 3600) return Math.floor(diffInSeconds / 60) + ' mins ago';
        if (diffInSeconds < 86400) return Math.floor(diffInSeconds / 3600) + ' hours ago';
        if (diffInSeconds < 604800) return Math.floor(diffInSeconds / 86400) + ' days ago';
        return date.toLocaleDateString();
    }

    function getInitials(name) {
        if (!name) return '?';
        const parts = name.trim().split(/\s+/).filter(Boolean);
        if (parts.length === 0) return '?';
        if (parts.length === 1) return parts[0][0].toUpperCase();
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }

    function getTypeMeta(type) {
        const types = {
            'Tenant': { icon: 'fa-user', bg: 'bg-blue-100', text: 'text-blue-800' },
            'Landlord': { icon: 'fa-building', bg: 'bg-purple-100', text: 'text-purple-800' },
            'Flex Broker': { icon: 'fa-handshake', bg: 'bg-green-100', text: 'text-green-800' },
            'Agent': { icon: 'fa-user-tie', bg: 'bg-orange-100', text: 'text-orange-800' },
            'Investor': { icon: 'fa-chart-line', bg: 'bg-indigo-100', text: 'text-indigo-800' },
            'Developer': { icon: 'fa-hard-hat', bg: 'bg-yellow-100', text: 'text-yellow-800' },
            'Solicitor': { icon: 'fa-gavel', bg: 'bg-red-100', text: 'text-red-800' },
            'Architect': { icon: 'fa-drafting-compass', bg: 'bg-teal-100', text: 'text-teal-800' },
            'Other': { icon: 'fa-user-tag', bg: 'bg-gray-100', text: 'text-gray-800' }
        };
        return types[type] || types['Other'];
    }

    function renderContactsTable(contacts) {
        const tbody = document.getElementById('contacts-table-body');
        if (!tbody) return;

        if (contacts.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="px-6 py-12 text-center text-secondary text-sm">
                        No contacts found.
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = contacts.map(contact => {
            const typeMeta = getTypeMeta(contact.type);
            const initials = getInitials(contact.name);
            
            return `
            <tr class="hover:bg-muted transition-all-smooth cursor-pointer contact-row" 
                onclick="showContactDetails(this)"
                data-contact-id="${contact.id}"
                data-contact-name="${escapeHtml(contact.name)}"
                data-contact-email="${escapeHtml(contact.email)}"
                data-contact-phone="${escapeHtml(contact.phone)}"
                data-contact-mobile="${escapeHtml(contact.mobile)}"
                data-contact-company="${escapeHtml(contact.company)}"
                data-contact-type="${escapeHtml(contact.type)}"
                data-contact-role="${escapeHtml(contact.role)}"
                data-contact-territory="${escapeHtml(contact.territory)}"
                data-contact-health="${escapeHtml(contact.health)}"
                data-contact-last-activity="${formatLastActivity(contact.lastActivity)}"
                data-contact-avatar="${contact.avatar || ''}"
                data-contact-notes="${escapeHtml(contact.notes || '')}"
            >
                <td class="px-6 py-4" onclick="event.stopPropagation()">
                    <input type="checkbox" class="w-4 h-4 text-primary border-[#E6E6E6] rounded focus:ring-primary">
                </td>
                <td class="px-6 py-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-medium text-sm">
                            ${initials}
                        </div>
                        <div>
                            <div class="font-semibold text-primary text-sm">${escapeHtml(contact.name || 'Unnamed')}</div>
                            <div class="text-xs text-secondary">${escapeHtml(contact.role || '-')}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${typeMeta.bg} ${typeMeta.text}">
                        <i class="fa-solid ${typeMeta.icon} mr-1.5"></i>
                        ${escapeHtml(contact.type || 'Other')}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm text-primary">${escapeHtml(contact.company || '-')}</td>
                <td class="px-6 py-4 text-sm text-primary">${escapeHtml(contact.email || '-')}</td>
                <td class="px-6 py-4 text-sm text-secondary">${escapeHtml(contact.phone || '-')}</td>
                <td class="px-6 py-4">
                    <div class="flex items-center space-x-2">
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-muted text-primary">
                            <i class="fa-solid fa-chart-line mr-1"></i>
                            0 deals
                        </span>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <i class="fa-solid fa-circle mr-1.5 text-[6px]"></i>
                        Active
                    </span>
                </td>
                <td class="px-6 py-4 text-right relative">
                    <button class="text-secondary hover:text-primary action-btn" onclick="event.stopPropagation(); toggleActionMenu('${contact.id}')">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </button>
                    <div id="action-menu-${contact.id}" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 border border-gray-200">
                        <div class="py-1">
                            <button type="button" onclick="event.preventDefault(); event.stopPropagation(); handleEditClick('${contact.id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fa-solid fa-pencil mr-2"></i> Edit
                            </button>
                            <a href="https://crm.zoho.eu/crm/org20066258959/tab/Contacts/${contact.id}" target="_blank" onclick="event.stopPropagation()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fa-solid fa-external-link-alt mr-2"></i> View in Zoho
                            </a>
                            <button type="button" onclick="event.preventDefault(); event.stopPropagation(); handleDeleteClick('${contact.id}')" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                                <i class="fa-solid fa-trash mr-2"></i> Delete
                            </button>
                        </div>
                    </div>
                </td>
            </tr>
            `;
        }).join('');
    }

    async function fetchContacts(forceRefresh = false) {
        if (isFetchingContacts && !forceRefresh) return;
        
        const tbody = document.getElementById('contacts-table-body');
        isFetchingContacts = true;
        
        // Only show loading if no data and not a background refresh
        if (tbody && contactsData.length === 0 && !forceRefresh) {
             tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="px-6 py-12 text-center text-secondary text-sm">
                        Loading contacts...
                    </td>
                </tr>
            `;
        }

        try {
            // Add a small delay if forcing refresh to allow Zoho API to catch up
            if (forceRefresh) {
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            const response = await fetch(`${CONTACTS_API_URL}?page=1&pageSize=100`);
            if (!response.ok) throw new Error('Failed to fetch contacts');
            
            const data = await response.json();
            const items = Array.isArray(data) ? data : (data.items || []);
            
            contactsData = items;
            applyFilters();
            
            if (forceRefresh) {
                const panel = document.getElementById('contact-details-panel');
                if (panel && panel.classList.contains('open')) {
                    const currentId = panel.dataset.currentContactId;
                    if (currentId) {
                        // Debug log
                        console.log('Forcing update for panel contact:', currentId);
                        
                        // 1. Try to find in fresh list first
                        const updatedFromList = items.find(c => c.id === currentId);
                        if (updatedFromList) {
                            console.log('Found updated contact in list, refreshing panel:', updatedFromList);
                            showContactDetails(updatedFromList);
                        } else {
                            // 2. Only fetch directly if not in the current list view
                            fetchContactById(currentId).then(directContact => {
                                if (directContact) {
                                    console.log('Fetched fresh contact directly:', directContact);
                                    showContactDetails(directContact);
                                }
                            });
                        }
                    }
                }
            }
            
        } catch (error) {
            console.error('Error fetching contacts:', error);
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="px-6 py-12 text-center text-red-500 text-sm">
                            Failed to load contacts.
                        </td>
                    </tr>
                `;
            }
        } finally {
            isFetchingContacts = false;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchContacts();
        generateNameFilterOptions();
        
        const trigger = document.getElementById('name-filter-trigger');
        if (trigger) {
            trigger.addEventListener('click', toggleNameFilterMenu);
        }
        
        document.addEventListener('click', function(e) {
             const menu = document.getElementById('name-filter-menu');
             const trigger = document.getElementById('name-filter-trigger');
             if (menu && !menu.classList.contains('hidden') && trigger && !trigger.contains(e.target) && !menu.contains(e.target)) {
                 menu.classList.add('hidden');
             }
        });

        const form = document.getElementById('add-contact-form');
        const successToast = document.getElementById('success-toast'); // Ensure this ID matches or is generic
        const modal = document.getElementById('add-contact-modal');

        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const payload = {
                    firstName: formData.get('first_name')?.toString() || null,
                    lastName: formData.get('last_name')?.toString() || '',
                    email: formData.get('email')?.toString() || '',
                    phone: formData.get('phone')?.toString() || null,
                    company: formData.get('company')?.toString() || null,
                    type: TYPE_VALUE_MAP[(formData.get('type') || '').toString()] || null,
                    role: formData.get('role')?.toString() || null,
                };

                try {
                    await createContact(payload);
                    // Show success logic here (assuming toast exists)
                    alert('Contact created successfully!');
                    form.reset();
                    // Close modal logic if function exists
                    closeContactModal();
                    fetchContacts(true);
                } catch (error) {
                    console.error('Error creating contact:', error);
                    alert('Failed to create contact: ' + error.message);
                }
            });
        }
    });
</script>
</body>
</html>
