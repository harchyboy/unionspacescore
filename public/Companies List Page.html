<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="union-logo.svg" />
  <title>Companies</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            border: "var(--border)",
            input: "var(--input)",
            ring: "var(--ring)",
            background: "var(--background)",
            foreground: "var(--foreground)",
            primary: {
              DEFAULT: "var(--primary)",
              foreground: "var(--primary-foreground)",
            },
            secondary: {
              DEFAULT: "var(--secondary)",
              foreground: "var(--secondary-foreground)",
            },
            destructive: {
              DEFAULT: "var(--destructive)",
              foreground: "var(--destructive-foreground)",
            },
            muted: {
              DEFAULT: "var(--muted)",
              foreground: "var(--muted-foreground)",
            },
            accent: {
              DEFAULT: "var(--accent)",
              foreground: "var(--accent-foreground)",
            },
            popover: {
              DEFAULT: "var(--popover)",
              foreground: "var(--popover-foreground)",
            },
            card: {
              DEFAULT: "var(--card)",
              foreground: "var(--card-foreground)",
            },
          },
          borderRadius: {
            lg: "var(--radius)",
            md: "calc(var(--radius) - 2px)",
            sm: "calc(var(--radius) - 4px)",
          },
          fontFamily: {
            sans: ["var(--font-sans)"],
            serif: ["var(--font-serif)"],
            mono: ["var(--font-mono)"],
          },
          boxShadow: {
            xs: "var(--shadow-xs)",
            sm: "var(--shadow-sm)",
            DEFAULT: "var(--shadow)",
            md: "var(--shadow-md)",
          },
        },
      },
    };
  </script>
  <script>
    window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --background: #FAFAFA;
      --foreground: #0f172a;
      --card: #ffffff;
      --card-foreground: #0f172a;
      --primary: #252525;
      --primary-foreground: #ffffff;
      --secondary: #8E8E8E;
      --secondary-foreground: #ffffff;
      --muted: #FAFAFA;
      --muted-foreground: #0f172a;
      --accent: #8E8E8E;
      --accent-foreground: #ffffff;
      --destructive: #ef4444;
      --destructive-foreground: #ffffff;
      --border: #E6E6E6;
      --input: #FFFFFF;
      --ring: #94a3b8;
      --font-sans: Inter, sans-serif;
      --font-serif: Georgia, serif;
      --font-mono: JetBrains Mono, monospace;
      --radius: 10px;
      --shadow-xs: 0 1px 2px rgba(15, 23, 42, 0.05);
      --shadow-sm: 0 1px 3px rgba(15, 23, 42, 0.08);
      --shadow: -2px 4px 12px 4px rgba(51,51,51,0.05);
      --shadow-md: 0 8px 30px rgba(15, 23, 42, 0.12);
    }

    ::-webkit-scrollbar { display: none; }

    body {
      font-family: var(--font-sans);
      background-color: #F0F0F0;
      color: #252525;
    }

    .transition-all-smooth { transition: all 0.2s ease-in-out; }
    .hover-lift:hover { transform: translateY(-2px); }
  </style>
  <script src="sidebar.js" defer></script>
</head>
<body class="antialiased" data-nav-section="companies">
  <div id="app-shell" class="flex h-screen overflow-hidden">
    <aside id="sidebar" class="w-64 bg-white border-r border-[#E6E6E6] flex flex-col" data-sidebar-placeholder data-active="companies"></aside>

    <main id="main-content" class="flex-1 flex flex-col overflow-hidden">
      <header id="header" class="bg-white border-b border-[#E6E6E6] px-8 py-4 flex items-center justify-between">
        <div>
          <p class="text-xs uppercase tracking-wider text-secondary mb-1">Intelligence</p>
          <h1 class="text-2xl font-semibold text-primary">Companies</h1>
          <p class="text-sm text-secondary">Manage brokerages, landlords, tenants, and supplier organisations from Zoho CRM Accounts.</p>
        </div>
        <div class="flex items-center space-x-3">
          <div class="relative">
            <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-secondary text-xs"></i>
            <input id="company-search" type="text" placeholder="Search companies..." class="pl-8 pr-3 py-2 w-64 bg-muted border border-[#E6E6E6] rounded-lg text-sm text-primary placeholder-secondary focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" />
          </div>
          <button id="add-company-button" class="px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg shadow hover:bg-primary/90 transition-all-smooth flex items-center space-x-2">
            <i class="fa-solid fa-building"></i>
            <span>Add Company</span>
          </button>
        </div>
      </header>

      <section class="flex-1 overflow-y-auto bg-[#F0F0F0] px-8 py-6 space-y-6">
        <div class="bg-white rounded-lg border border-[#E6E6E6] overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-muted border-b border-[#E6E6E6]">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Name</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">City</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Website</th>
                  <th class="px-6 py-3 text-right text-xs font-semibold text-secondary uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="companies-table-body" class="divide-y divide-[#E6E6E6]">
                <tr>
                  <td colspan="4" class="px-6 py-10 text-center text-secondary text-sm">
                    Loading companies...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-6">
          <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-medium text-secondary">Total Companies</div>
              <i class="fa-solid fa-building text-primary"></i>
            </div>
            <div id="total-companies-count" class="text-3xl font-semibold text-primary">—</div>
            <div class="text-xs text-secondary mt-2">Synced from Zoho CRM Accounts</div>
          </div>

          <div class="bg-white rounded-lg border border-[#E6E6E6] p-6">
            <div class="text-sm font-medium text-secondary mb-2">Notes</div>
            <p class="text-xs text-secondary leading-relaxed">
              This view is backed directly by the Zoho CRM <strong>Accounts</strong> module.
              Creating a company here will create an Account in Zoho, and those Accounts
              are available everywhere you use the company lookup (e.g. Add Contact).
            </p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Add Company Modal -->
  <div id="company-modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-40 z-40"></div>
  <div id="company-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4">
    <div class="bg-white rounded-lg shadow-md border border-[#E6E6E6] w-full max-w-md">
      <div class="px-6 py-4 border-b border-[#E6E6E6] flex items-center justify-between">
        <div>
          <h2 class="text-lg font-semibold text-primary" id="company-modal-title">Add Company</h2>
          <p class="text-xs text-secondary mt-1">Creates a Zoho CRM Account record.</p>
        </div>
        <button id="company-modal-close" class="text-secondary hover:text-primary">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <form id="company-form" class="px-6 py-4 space-y-4">
        <div>
          <label for="company-name-input" class="block text-xs font-medium text-secondary uppercase tracking-wider mb-1">Company Name<span class="text-destructive ml-1">*</span></label>
          <input id="company-name-input" type="text" class="w-full border border-[#E6E6E6] rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required />
        </div>
        <div>
          <label for="company-city-input" class="block text-xs font-medium text-secondary uppercase tracking-wider mb-1">City / Region</label>
          <input id="company-city-input" type="text" class="w-full border border-[#E6E6E6] rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" />
        </div>
        <div class="flex items-center justify-end space-x-3 pt-2">
          <button type="button" id="company-cancel-button" class="px-4 py-2 border border-[#E6E6E6] rounded-lg text-sm text-secondary hover:text-primary hover:border-primary transition-all-smooth">
            Cancel
          </button>
          <button type="submit" id="company-submit-button" class="px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg shadow hover:bg-primary/90 transition-all-smooth">
            Save Company
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="company-toast" class="hidden fixed bottom-8 right-8 bg-primary text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 z-50">
    <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
      <i class="fa-solid fa-check text-white"></i>
    </div>
    <div>
      <div id="company-toast-title" class="font-semibold">Company created</div>
      <div id="company-toast-subtitle" class="text-xs opacity-90">Account synced with Zoho CRM.</div>
    </div>
  </div>

  <script>
    const ACCOUNTS_API_URL = '/api/accounts';
    let companiesData = [];
    let isFetchingCompanies = false;
    let currentSearch = '';

    function escapeHtml(value) {
      if (!value) return '';
      return value.replace(/[&<>"']/g, function (match) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return map[match];
      });
    }

    function renderCompaniesTable(items) {
      const tbody = document.getElementById('companies-table-body');
      const totalEl = document.getElementById('total-companies-count');
      if (!tbody) return;

      if (!items.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="px-6 py-10 text-center text-secondary text-sm">
              No companies found. Try adjusting your search or add a new company.
            </td>
          </tr>
        `;
      } else {
        tbody.innerHTML = items
          .map(function (company) {
            const name = escapeHtml(company.name);
            const city = escapeHtml(company.city || '');
            const website = escapeHtml(company.website || '');
            const websiteDisplay = website || '—';
            const websiteLink = website
              ? `<a href="${website.startsWith('http') ? website : 'https://' + website}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">${websiteDisplay}</a>`
              : websiteDisplay;

            return `
              <tr class="hover:bg-[#FAFAFA]">
                <td class="px-6 py-3 text-sm text-primary">${name}</td>
                <td class="px-6 py-3 text-sm text-secondary">${city || '—'}</td>
                <td class="px-6 py-3 text-sm text-secondary">${websiteLink}</td>
                <td class="px-6 py-3 text-sm text-right">
                  <span class="text-xs text-secondary">ID: ${escapeHtml(company.id)}</span>
                </td>
              </tr>
            `;
          })
          .join('');
      }

      if (totalEl) {
        totalEl.textContent = items.length.toString();
      }
    }

    async function fetchCompanies(force) {
      if (isFetchingCompanies && !force) return;
      isFetchingCompanies = true;

      const tbody = document.getElementById('companies-table-body');
      if (tbody) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="px-6 py-10 text-center text-secondary text-sm">
              Loading companies…
            </td>
          </tr>
        `;
      }

      try {
        let url = ACCOUNTS_API_URL;
        const trimmed = currentSearch.trim();
        if (trimmed && trimmed.length >= 2) {
          url += `?search=${encodeURIComponent(trimmed)}`;
        }

        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Unable to load companies');
        }
        const data = await response.json();
        const items = Array.isArray(data.items) ? data.items : [];
        companiesData = items;
        renderCompaniesTable(items);
      } catch (error) {
        console.error(error);
        if (tbody) {
          tbody.innerHTML = `
            <tr>
              <td colspan="4" class="px-6 py-10 text-center text-destructive text-sm">
                Failed to load companies. Please try again later.
              </td>
            </tr>
          `;
        }
      } finally {
        isFetchingCompanies = false;
      }
    }

    async function createCompany(payload) {
      const response = await fetch(ACCOUNTS_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        const error = await response.json().catch(function () { return {}; });
        throw new Error(error.message || 'Failed to create company');
      }

      return response.json();
    }

    function showCompanyToast(title, subtitle) {
      const toast = document.getElementById('company-toast');
      const titleEl = document.getElementById('company-toast-title');
      const subEl = document.getElementById('company-toast-subtitle');
      if (!toast || !titleEl || !subEl) return;
      titleEl.textContent = title;
      subEl.textContent = subtitle;
      toast.classList.remove('hidden');
      setTimeout(function () {
        toast.classList.add('hidden');
      }, 3000);
    }

    function openCompanyModal() {
      document.getElementById('company-modal-backdrop')?.classList.remove('hidden');
      document.getElementById('company-modal')?.classList.remove('hidden');
      const nameInput = document.getElementById('company-name-input');
      if (nameInput) {
        nameInput.value = '';
        nameInput.focus();
      }
      const cityInput = document.getElementById('company-city-input');
      if (cityInput) {
        cityInput.value = '';
      }
    }

    function closeCompanyModal() {
      document.getElementById('company-modal-backdrop')?.classList.add('hidden');
      document.getElementById('company-modal')?.classList.add('hidden');
    }

    function debounce(fn, delay) {
      let timeoutId;
      return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(function () {
          fn.apply(null, args);
        }, delay);
      };
    }

    document.addEventListener('DOMContentLoaded', function () {
      const searchInput = document.getElementById('company-search');
      if (searchInput) {
        searchInput.addEventListener('input', debounce(function (event) {
          currentSearch = event.target.value || '';
          fetchCompanies(true);
        }, 300));
      }

      const addButton = document.getElementById('add-company-button');
      if (addButton) {
        addButton.addEventListener('click', function () {
          openCompanyModal();
        });
      }

      const cancelButton = document.getElementById('company-cancel-button');
      const closeButton = document.getElementById('company-modal-close');
      if (cancelButton) cancelButton.addEventListener('click', closeCompanyModal);
      if (closeButton) closeButton.addEventListener('click', closeCompanyModal);
      const backdrop = document.getElementById('company-modal-backdrop');
      if (backdrop) {
        backdrop.addEventListener('click', closeCompanyModal);
      }

      const form = document.getElementById('company-form');
      if (form) {
        form.addEventListener('submit', async function (event) {
          event.preventDefault();
          const nameInput = document.getElementById('company-name-input');
          const cityInput = document.getElementById('company-city-input');
          const submitButton = document.getElementById('company-submit-button');

          if (!nameInput || !nameInput.value.trim()) {
            nameInput?.focus();
            return;
          }

          const name = nameInput.value.trim();
          const city = cityInput?.value.trim() || undefined;

          if (submitButton) {
            submitButton.setAttribute('disabled', 'true');
            submitButton.textContent = 'Saving...';
          }

          try {
            await createCompany({ name, city });
            closeCompanyModal();
            showCompanyToast('Company created', 'Zoho CRM Account created successfully.');
            currentSearch = name;
            if (searchInput) {
              searchInput.value = name;
            }
            await fetchCompanies(true);
          } catch (error) {
            console.error(error);
            showCompanyToast('Failed to create company', error instanceof Error ? error.message : 'Unexpected error');
          } finally {
            if (submitButton) {
              submitButton.removeAttribute('disabled');
              submitButton.textContent = 'Save Company';
            }
          }
        });
      }

      // Initial load
      fetchCompanies(true);
    });
  </script>
</body>
</html>


